---
title: 'GMM sensitivity analyses'
author: "Katherine N Thompson"
date: "02 Feb 2021"
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
    number_sections: no
    highlight: monochrome
    theme: cerulean
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE)


options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment}
remove(list = ls())
```

```{r colour palletes for graphs}
palette2 <- c("#78D9C5","#F5BE5E")
palette2b <- c("#78D9C5","#EEB6E9")
```
 
```{r source the data file path}
#source raw data directory: data_raw and data included
source("../../../../../isolation_trajectories_data_path.R")
```

```{r Mplus packages}
library(MplusAutomation)
library(stringr)
library(stringi)
library(filesstrings)
library(texreg)
library(relimp)
library(rhdf5)
library(knitr)
library(ggplot2)
library(tidyverse)
library(plyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r MplusAutomation citation}
citation("MplusAutomation")
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat <- readRDS(file = paste0(data_path, "class_joined_preprocessed_isolation_data_full_sample.rds"))
colnames(dat)
```

# Posterior probability check

Exclude everyone with a probability lower than 0.8 and see if results replicate. 

```{r frequency of those with probabilities lower than 0.8}
# create new variable only with those who have a probability higher than 0.8 for each class
dat <- dat %>%
  mutate(class_renamed_cut =
           factor(
             case_when(
             prob2 > 0.8 & class_renamed == "Increasing" ~ "Increasing",
             prob3 > 0.8 & class_renamed == "Decreasing" ~ "Decreasing",
             prob1 > 0.8 & class_renamed == "Low stable" ~ "Low stable"
           ), 
           ordered = FALSE))
```

```{r relevel class, include=FALSE}
library(nnet)
# check the biggest group in the class to be the reference group
table(dat$class_renamed_cut)

# relevel class_factor
dat <- dat %>% 
  mutate(
    class_reordered_cut =
      relevel(
        class_renamed_cut,
        ref = "Low stable",
        first = TRUE, #levels in ref come first
        collapse = "+", #String used when constructing names for combined factor levels
        xlevels = TRUE #levels maintained even if not actually occurring
        
      )
  )
# check
table(dat$class_reordered_cut)
```

```{r new cut dataset}
# create new dataset with only these individuals
dat_prob_cut <- dat %>% filter(!is.na(class_reordered_cut))

dat_prob_cut_LOW <- dat %>% filter(is.na(class_reordered_cut))
```

```{r freq of new dataset}
freq(dat_prob_cut$class_reordered_cut)
```


```{r descriptives for probabilites}
low.stable.cut.stats <- dat_prob_cut_LOW %>%
  filter(class_reordered == "Low stable") %>%
  descr(prob1)

increasing.cut.stats <- dat_prob_cut_LOW %>%
  filter(class_reordered == "Increasing") %>%
  descr(prob2)

decreasing.cut.stats <- dat_prob_cut_LOW %>%
  filter(class_reordered == "Decreasing") %>%
  descr(prob3)

low.stable.cut.stats
increasing.cut.stats
decreasing.cut.stats
```

Low stable: Dropped 42 people. Average probability = 0.66, minimum probability = 0.48. 
Increasing: Dropped 24 people. Average probability = 0.64, minimum probability = 0.49.
Decreasing: Dropped 25 people. Average probability = 0.63, minimum probability = 0.51. 

# *Rerunning antecedent individual regressions*

## List of variables

```{r variable character lists, include=FALSE}
antecedent.independent.numeric <- c("SES_binary_releveled_numeric",
                                    "acorn_continuous_05",
                                    "vandalism_05",
                                    "problems_neighbours_05",
                                    "number_children_school_05",
                                    "number_children_school_free_meals_05",
                                    "child_harm_recoded_numeric_05",
                                    "total_siblings_05",
                                    "total_social_support_05",
                                    "total_activities_with_mum_05",
                                    "mum_notlived_biodad_sincebirth_numeric_05",
                                    "any_domestic_violence_numeric_05",
                                    "maternal_warmth_continuous_05",
                                    "maternal_depression_lifetime_numeric_05",
                                    "maternal_personality_openness_05",
                                    "maternal_personality_conscientiousness_05",
                                    "maternal_personality_extroversion_05",
                                    "maternal_personality_agreeableness_05",
                                    "maternal_personality_neuroticism_05",
                                    "antisocial_behaviour_parent_05",
                                    "alcoholism_parent_05", # kept in for correlaiton heat map
                                    "IQ_05",
                                    "executive_function_05",
                                    "theory_of_mind_05",
                                    "externalising_combined_05",
                                    "internalising_combined_excl_sis_05",
                                    "ADHD_combined_05",
                                    "prosocial_behaviours_combined_05")

name.list.numeric <- c("SES: Low",
                       "ACORN", 
                       "Vandalism", 
                       "Problems with neighbours", 
                       "Number of children in school", 
                       "Number of children eligible for free school meals",
                       "Child harm: Harmed",
                       "Total siblings",
                       "Social support", 
                       "Total activities with mum",
                       "Mum not lived with biological dad since birth: Yes", 
                       "Any domestic violence: Yes",
                       "Maternal warmth",
                       "Maternal lifetime depression: Yes",
                       "Maternal personality: Openness",
                       "Maternal personality: Conscientiousness",
                       "Maternal personality: Extroversion",
                       "Maternal personality: Agreeableness",
                       "Maternal personality: Neuroticism",
                       "Parental antisocial behaviour",
                       "Parental alcoholism", # kept in for correlation matrix
                       "Child IQ",
                       "Child executive function",
                       "Child theory of mind",
                       "Child externalising behaviours",
                       "Child internalising behaviours",
                       "Child ADHD behaviours",
                       "Child prosocial behaviours")

antecedent.independent.continuous <- c("acorn_continuous_05",
                                      "vandalism_05",
                                      "problems_neighbours_05",
                                      "number_children_school_05",
                                      "number_children_school_free_meals_05",
                                      "total_siblings_05",
                                      "total_social_support_05",
                                      "total_activities_with_mum_05",
                                      "maternal_warmth_continuous_05",
                                      "maternal_personality_openness_05",
                                      "maternal_personality_conscientiousness_05",
                                      "maternal_personality_extroversion_05",
                                      "maternal_personality_agreeableness_05",
                                      "maternal_personality_neuroticism_05",
                                      "antisocial_behaviour_parent_05",
                                  #    "alcoholism_parent_05",
                                      "IQ_05",
                                      "executive_function_05",
                                      "theory_of_mind_05",
                                      "externalising_combined_05",
                                      "internalising_combined_excl_sis_05",
                                      "ADHD_combined_05",
                                      "prosocial_behaviours_combined_05")

antecedent.independent.continuous.loop <- c("z_score.acorn_continuous_05",
                                            "z_score.vandalism_05",
                                            "z_score.problems_neighbours_05",
                                            "z_score.number_children_school_05",
                                            "z_score.number_children_school_free_meals_05",
                                            "z_score.total_siblings_05",
                                            "z_score.total_social_support_05",
                                            "z_score.total_activities_with_mum_05",
                                            "z_score.maternal_warmth_continuous_05",
                                            "z_score.maternal_personality_openness_05",
                                            "z_score.maternal_personality_conscientiousness_05",
                                            "z_score.maternal_personality_extroversion_05",
                                            "z_score.maternal_personality_agreeableness_05",
                                            "z_score.maternal_personality_neuroticism_05",
                                            "z_score.antisocial_behaviour_parent_05",
                                      #      "z_score.alcoholism_parent_05",
                                            "z_score.IQ_05",
                                            "z_score.executive_function_05",
                                            "z_score.theory_of_mind_05",
                                            "z_score.externalising_combined_05",
                                            "z_score.internalising_combined_excl_sis_05",
                                            "z_score.ADHD_combined_05",
                                            "z_score.prosocial_behaviours_combined_05")

name.list.continuous.loop <- c("ACORN", 
                               "Vandalism", 
                               "Problems with neighbours", 
                               "Number of children in school", 
                               "Number of children eligible for free school meals",
                               "Total siblings",
                               "Social support", 
                               "Total activities with mum",
                               "Maternal warmth",
                               "Maternal personality: Openness",
                               "Maternal personality: Conscientiousness",
                               "Maternal personality: Extroversion",
                               "Maternal personality: Agreeableness",
                               "Maternal personality: Neuroticism",
                               "Parental antisocial behaviour",
                          #     "Parental alcoholism",
                               "Child IQ",
                               "Child executive function",
                               "Child theory of mind",
                               "Child externalising behaviours",
                               "Child internalising behaviours",
                               "Child ADHD behaviours",
                               "Child prosocial behaviours")

antecedent.independent <- c("SES_binary_releveled",
                            "acorn_continuous_05",
                            "vandalism_05",
                            "problems_neighbours_05",
                            "number_children_school_05",
                            "number_children_school_free_meals_05",
                            "child_harm_recoded_05",
                            "total_siblings_05",
                            "total_social_support_05",
                            "total_activities_with_mum_05",
                            "mum_notlived_biodad_sincebirth_05",
                            "any_domestic_violence_05",
                            "maternal_warmth_continuous_05",
                            "maternal_depression_lifetime_05",
                            "maternal_personality_openness_05",
                            "maternal_personality_conscientiousness_05",
                            "maternal_personality_extroversion_05",
                            "maternal_personality_agreeableness_05",
                            "maternal_personality_neuroticism_05",
                            "antisocial_behaviour_parent_05",
                       #     "alcoholism_parent_05",
                            "IQ_05",
                            "executive_function_05",
                            "theory_of_mind_05",
                            "externalising_combined_05",
                            "internalising_combined_excl_sis_05",
                            "ADHD_combined_05",
                            "prosocial_behaviours_combined_05")
                                 
name.list <- c("SES: Low",
               "ACORN", 
               "Vandalism", 
               "Problems with neighbours", 
               "Number of children in school", 
               "Number of children eligible for free school meals",
               "Child harm: Harmed",
               "Total siblings",
               "Social support", 
               "Total activities with mum",
               "Mum not lived with biological dad since birth: Yes", 
               "Any domestic violence: Yes",
               "Maternal warmth",
               "Maternal lifetime depression: Yes",
               "Maternal personality: Openness",
               "Maternal personality: Conscientiousness",
               "Maternal personality: Extroversion",
               "Maternal personality: Agreeableness",
               "Maternal personality: Neuroticism",
               "Parental antisocial behaviour",
          #     "Parental alcoholism",
               "Child IQ",
               "Child executive function",
               "Child theory of mind",
               "Child externalising behaviours",
               "Child internalising behaviours",
               "Child ADHD behaviours",
               "Child prosocial behaviours")


```

## Theme for plotting

```{r theme for all plots}
theme.antecedent <- theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9),
        axis.text.y = element_text(colour = "black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom",
        strip.text.y = element_blank())
```

# Individual antecedents 

```{r loop for running antecedent regressions, include=FALSE}
multinom.stats.ant <- list() #create empty list to store the information in

for (i in 1:length(antecedent.independent))
{ cat(i)
  multinom.formula.ant <- as.formula(sprintf("class_reordered_cut ~ %s", antecedent.independent[i]))

  multinom.reg.ant <- multinom(multinom.formula.ant, data = dat_prob_cut)

  multinom.output.ant.full <- broom::tidy(multinom.reg.ant, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,3),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)
 
  if (i < 7) {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Social block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 6))
  } else if (i < 14 ) {
   multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Home block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 21) {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Parent block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 24) {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Neuro block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 3))
  } else {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Emo/behave block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  }
  
   multinom.output.ant.full <- multinom.output.ant.full %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  multinom.stats.ant[[i]] <- multinom.output.ant.full
}
# set the names of the list to match the variable names
names(multinom.stats.ant) <- antecedent.independent
```

## Call statistics from loop

```{r call statistics for all antecedent regressions, include=FALSE}
for (i in 1:length(antecedent.independent))
{ 
  assign(paste0("multinom.", names(multinom.stats.ant[i])), as.tibble(multinom.stats.ant[[i]]))
}
```

# Create *z scores* for all continuous variables

```{r scale continuous variables and combine to main dataset}
# create a scaled version of the continuous variables - z scores for all variables
scaled_continuous_data <- as.data.frame(scale(dat_prob_cut[antecedent.independent.continuous], center = TRUE, scale = TRUE))

# rename variables to show that they are z scores 
colnames(scaled_continuous_data) <- paste0("z_score.", colnames(scaled_continuous_data))

# combine the scaled data to the main dataset 
dat_prob_cut <- cbind(dat_prob_cut, scaled_continuous_data)
```

## Create loop using the *z scores* for plotting continuous variables

```{r loop for running antecedent regressions, include=FALSE}
multinom.stats.ant.cont <- list() #create empty list to store the information in

for (i in 1:length(antecedent.independent.continuous.loop))
{ cat(i)
  multinom.formula.ant.cont <- as.formula(sprintf("class_reordered ~ %s", antecedent.independent.continuous.loop[i]))

  multinom.reg.ant.cont <- multinom(multinom.formula.ant.cont, data = dat_prob_cut)

  multinom.output.ant.full.cont <- broom::tidy(multinom.reg.ant.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,3),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)
 
  if (i < 6) {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Social block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 6))
  } else if (i < 10 ) {
   multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Home block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 16) {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Parent block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 19) {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Neuro block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 3))
  } else {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Emo/behave block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  }
  
   multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  multinom.stats.ant.cont[[i]] <- multinom.output.ant.full.cont
}
# set the names of the list to match the variable names
names(multinom.stats.ant.cont) <- antecedent.independent.continuous.loop
```

```{r call statistics for zscore continuous antecedent regressions, include=FALSE}
for (i in 1:length(antecedent.independent.continuous.loop))
{ 
  assign(paste0("multinom.", names(multinom.stats.ant.cont[i])), as.tibble(multinom.stats.ant.cont[[i]]))
}
```

# Table including all statistics for individual antecedent regressions

```{r table for all individual regressions - z score}
# combining z score loop output (continuous only) with the original categorical regressions
data.ant_full.table.cont <- data.table::rbindlist(multinom.stats.ant.cont)
data.ant_full.table.cont <- rbind(data.ant_full.table.cont, 
                                  multinom.SES_binary_releveled, 
                                  multinom.mum_notlived_biodad_sincebirth_05,
                                  multinom.any_domestic_violence_05,
                                  multinom.child_harm_recoded_05,
                                  multinom.maternal_depression_lifetime_05) %>%
  select(Class, 
         Variable, 
         block, 
         RRR, 
         RRR.conf.low, 
         RRR.conf.high, 
         std.error,
         p.value.adjusted,
         Significance)
```

```{r word table of individual antecedent regressions - z scores}
kable(data.ant_full.table.cont %>% mutate_if(is.numeric, ~round(., 3)))
```

# Graph for individual antecedent regressions

## bind non trasformed values

```{r bind and order rows}
# social
data.ant_social.ordered <- filter(data.ant_full.table, block == "Social block") %>% 
  arrange(desc(RRR)) 

data.ant_social.ordered$Variable <- factor(data.ant_social.ordered$Variable, levels = paste(unique(paste(data.ant_social.ordered$Variable)), sep = ","))

#home
data.ant_home.ordered <- filter(data.ant_full.table, block == "Home block") %>% 
  arrange(desc(RRR)) 

data.ant_home.ordered$Variable <- factor(data.ant_home.ordered$Variable,levels = paste(unique(paste(data.ant_home.ordered$Variable)),sep = ","))

#parent
data.ant_parent.ordered <- filter(data.ant_full.table, block == "Parent block") %>% 
  arrange(desc(RRR))

data.ant_parent.ordered$Variable <- factor(data.ant_parent.ordered$Variable,levels = paste(unique(paste(data.ant_parent.ordered$Variable)),sep = ","))

#neuro
data.ant_neuro.ordered <- filter(data.ant_full.table, block == "Neuro block") %>% 
  arrange(desc(RRR))

data.ant_neuro.ordered$Variable <- factor(data.ant_neuro.ordered$Variable,levels = paste(unique(paste(data.ant_neuro.ordered$Variable)),sep = ","))

#emo/behave
data.ant_emo_behave.ordered <- filter(data.ant_full.table, block == "Emo/behave block") %>% 
  arrange(desc(RRR))

data.ant_emo_behave.ordered$Variable <- factor(data.ant_emo_behave.ordered$Variable,levels = paste(unique(paste(data.ant_emo_behave.ordered$Variable)),sep = ","))

# all
data.ant_full.ordered <- rbind(
  data.ant_social.ordered,
  data.ant_home.ordered,
  data.ant_parent.ordered,
  data.ant_neuro.ordered,
  data.ant_emo_behave.ordered
)
```

## bind *z score* trasformed values

```{r bind and order rows}
# social
data.ant_social.ordered.cont <- filter(data.ant_full.table.cont, block == "Social block") %>% 
  arrange(desc(RRR)) 

data.ant_social.ordered.cont$Variable <- factor(data.ant_social.ordered.cont$Variable, levels = paste(unique(paste(data.ant_social.ordered.cont$Variable)), sep = ","))

#home
data.ant_home.ordered.cont <- filter(data.ant_full.table.cont, block == "Home block") %>% 
  arrange(desc(RRR)) 

data.ant_home.ordered.cont$Variable <- factor(data.ant_home.ordered.cont$Variable,levels = paste(unique(paste(data.ant_home.ordered.cont$Variable)),sep = ","))

#parent
data.ant_parent.ordered.cont <- filter(data.ant_full.table.cont, block == "Parent block") %>% 
  arrange(desc(RRR))

data.ant_parent.ordered.cont$Variable <- factor(data.ant_parent.ordered.cont$Variable,levels = paste(unique(paste(data.ant_parent.ordered.cont$Variable)),sep = ","))

#neuro
data.ant_neuro.ordered.cont <- filter(data.ant_full.table.cont, block == "Neuro block") %>% 
  arrange(desc(RRR))

data.ant_neuro.ordered.cont$Variable <- factor(data.ant_neuro.ordered.cont$Variable,levels = paste(unique(paste(data.ant_neuro.ordered.cont$Variable)),sep = ","))

#emo/behave
data.ant_emo_behave.ordered.cont <- filter(data.ant_full.table.cont, block == "Emo/behave block") %>% 
  arrange(desc(RRR))

data.ant_emo_behave.ordered.cont$Variable <- factor(data.ant_emo_behave.ordered.cont$Variable,levels = paste(unique(paste(data.ant_emo_behave.ordered.cont$Variable)),sep = ","))

# all
data.ant_full.ordered.cont <- rbind(
  data.ant_social.ordered.cont,
  data.ant_home.ordered.cont,
  data.ant_parent.ordered.cont,
  data.ant_neuro.ordered.cont,
  data.ant_emo_behave.ordered.cont
)
```

## Plots of individual antecedent regressions

```{r antecedent plot with separated classes}
ant.all.separate.plot.cont <- ggplot(
  data.ant_full.ordered.cont, # CHANGE DEPENDING IF YOU WANT TO USE Z SCORES OR NOT - remember to rename the plot if you change it
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       title = "Association between antecedents and social isolation class membership",
       subtitle = paste("N(Total) = ", length(dat_prob_cut$sex),
                        "; N(Increasing) = ", sum(!is.na(dat_prob_cut$class_renamed[dat_prob_cut$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat_prob_cut$class_renamed[dat_prob_cut$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.2,0.4,0.6,0.8, 1, 1.5, 2, 2.5, 3, 4)) +
  coord_flip()

ant.all.separate.plot.cont

#save
ggsave(
  "Sensitivity_prob_cut0.8_all_antecedents_individual_regressions_using_zscores.png",
  plot = ant.all.separate.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/sensitivity"),
  width = 12,
  height = 9
)
```
 
# *Rerunning outcomes* - names will be overwritten

```{r outcome lists }
outcome.dependent <- c( # mental health
                      "depression_diagnosis_12mo_18", 
                       "depression_current_scale_18",
                       "anxiety_diagnosis_18", 
                       "anxiety_current_scale_18",
                       "ADHD_diagnosis_18", 
                       "inattentive_hyperactive_symptoms_total_18",
                       "conduct_disorder_moderate_18", 
                       "conduct_disorder_symptoms_18", 
                       "alcohol_dependence_18", 
                       "alcohol_abuse_18", # combine with the above?
                       "alcohol_symptom_scale_18",
                       "cannabis_dependence_18", 
                       "cannabis_symptom_scale_18", 
                       "PTSD_diagnosis_lifetime_18", 
                       "PTSD_diagnosis_current_18", 
                       "cat_psychosis_experiences_scale_18", 
                       "suicide_attempt_selfharm_18", 
                       "service_use_18", 
                      # physical health
                       "BMI_18", 
                       "CRP_log_18",
                       "physical_activity_18",
                       "smoking_current_number_18",
                      # coping and functioning
                       "loneliness_18",
                       "life_satisfaction_18",
                       "technology_use_18",
                       "coping_with_stress_18",
                       "PSQI_global_score_18",
                      # employment
                       "not_in_employment_education_18", 
                       "job_preparedness_skills_18",
                       "job_preparedness_attributes_18",
                       "optimism_18",
                       "job_search_activities_count_18")

outcome.dependent.numeric <- c( # mental health
                               "depression_diagnosis_12mo_numeric_18", 
                               "depression_current_scale_18",
                               "anxiety_diagnosis_numeric_18", 
                               "anxiety_current_scale_18",
                               "ADHD_diagnosis_numeric_18", 
                               "inattentive_hyperactive_symptoms_total_18",
                               "conduct_disorder_moderate_numeric_18", 
                               "conduct_disorder_symptoms_18", 
                               "alcohol_dependence_numeric_18", 
                               "alcohol_abuse_numeric_18", # combine with the above?
                               "alcohol_symptom_scale_18",
                               "cannabis_dependence_numeric_18", 
                               "cannabis_symptom_scale_18", 
                               "PTSD_diagnosis_lifetime_numeric_18", 
                               "PTSD_diagnosis_current_numeric_18", 
                               "cat_psychosis_experiences_scale_numeric_18", 
                               "suicide_attempt_selfharm_numeric_18", 
                               "service_use_numeric_18", 
                               "BMI_18", # physical health
                               "CRP_log_18",
                               "physical_activity_18",
                               "smoking_current_number_18",
                               "loneliness_18", # coping and functioning
                               "life_satisfaction_18",
                               "technology_use_18",
                               "coping_with_stress_18",
                               "PSQI_global_score_18",
                               "not_in_employment_education_numeric_18", # employment
                               "job_preparedness_skills_18",
                               "job_preparedness_attributes_18",
                               "optimism_18",
                               "job_search_activities_count_18")

name.list <- c(
              "Depression diagnosis: Yes",
              "Current depression",
              "Anxiety diagnosis: Yes",
              "Current anxiety",
              "ADHD diagnosis: Yes",
              "Current inattentive and hyperactive symptoms",
              "Moderate conduct disorder: Yes",
              "Current conduct disorder symptoms",
              "Alcohol dependence: Yes",
              "Alcohol abuse: Yes",
              "Current alcohol dependence symptoms",
              "Cannabis dependence: Yes",
              "Current canabis dependence symptoms",
              "PTSD lifetime diagnosis: Yes",
              "PTSD current diagnosis: Yes",
              "Expereinces of psychosis",
              "Suicide attempt: Yes",
              "Service use: Yes",
              "BMI",
              "Log CRP",
              "Physical activity",
              "Current number of cigarettes smoked",
              "Loneliness",
              "Life satisfaction",
              "Technology use",
              "Coping with stress",
              "PSQI score",
              "Not in employment or education: Yes",
              "Job preparedness: skills",
              "Job preparedness: attributes",
              "Optimism",
              "Job search activities")

outcome.dependent.linear <- c(
  "depression_current_scale_18", # mental health
  "anxiety_current_scale_18",
  "inattentive_hyperactive_symptoms_total_18",
  "conduct_disorder_symptoms_18", 
  "alcohol_symptom_scale_18",
  "cannabis_symptom_scale_18", 
  "cat_psychosis_experiences_scale_numeric_18", # can to be numeric to be in linear regression
  "BMI_18", # physical health
  "CRP_log_18",
  "physical_activity_18",
  "smoking_current_number_18",
  "loneliness_18", #coping and functioning
  "life_satisfaction_18",
  "technology_use_18",
  "coping_with_stress_18",
  "PSQI_global_score_18",
  "job_preparedness_skills_18", #employment
  "job_preparedness_attributes_18",
  "optimism_18",
  "job_search_activities_count_18"
)

outcome.dependent.linear.zscore <- c(
  "z_score.depression_current_scale_18", # mental health
  "z_score.anxiety_current_scale_18",
  "z_score.inattentive_hyperactive_symptoms_total_18",
  "z_score.conduct_disorder_symptoms_18", 
  "z_score.alcohol_symptom_scale_18",
  "z_score.cannabis_symptom_scale_18", 
  "z_score.cat_psychosis_experiences_scale_numeric_18", # can to be numeric to be in linear regression
  "z_score.BMI_18", # physical health
  "z_score.CRP_log_18",
  "z_score.physical_activity_18",
  "z_score.smoking_current_number_18",
  "z_score.loneliness_18", #coping and functioning
  "z_score.life_satisfaction_18",
  "z_score.technology_use_18",
  "z_score.coping_with_stress_18",
  "z_score.PSQI_global_score_18",
  "z_score.job_preparedness_skills_18", #employment
  "z_score.job_preparedness_attributes_18",
  "z_score.optimism_18",
  "z_score.job_search_activities_count_18"     
)

outcome.dependent.linear.name.list <- c(
                                        "Current depression",
                                        "Current anxiety",
                                        "Current inattentive and hyperactive symptoms",
                                        "Current conduct disorder symptoms",
                                        "Current alcohol dependence symptoms",
                                        "Current cannabis dependence symptoms",
                                        "Expereinces of psychosis",
                                        "BMI",
                                        "Log CRP",
                                        "Physical activity",
                                        "Current number of cigarettes smoked",
                                        "Loneliness",
                                        "Life satisfaction",
                                        "Technology use",
                                        "Coping with stress",
                                        "PSQI score",
                                        "Job preparedness: skills",
                                        "Job preparedness: attributes",
                                        "Optimism",
                                        "Job search activities")

outcome.dependent.logistic <- c(
  "depression_diagnosis_12mo_18", # mental health 
  "anxiety_diagnosis_18", 
  "ADHD_diagnosis_18",
  "conduct_disorder_moderate_18",
  "alcohol_dependence_18",
  "alcohol_abuse_18", 
  "cannabis_dependence_18", 
  "PTSD_diagnosis_lifetime_18", 
  "PTSD_diagnosis_current_18", 
  "suicide_attempt_selfharm_18", 
  "service_use_18",
  "not_in_employment_education_18" #employment
)

outcome.dependent.logistic.name.list <- c(
  "Depression diagnosis",
  "Anxiety diagnosis",
  "ADHD diagnosis",
  "Moderate conduct disorder",
  "Alcohol dependence",
  "Alcohol abuse",
  "Cannabis dependence",
  "PTSD lifetime diagnosis",
  "PTSD current diagnosis",
  "Suicide attempt",
  "Service use",
  "Not in employment or education"
)
```

# Create *z scores* for all continuous variables

```{r scale continuous variables and combine to main dataset}
# create a scaled version of the continuous variables - z scores for all variables
scaled_continuous_data <- as.data.frame(scale(dat_prob_cut[outcome.dependent.linear], center = TRUE, scale = TRUE))

# rename variables to show that they are z scores 
colnames(scaled_continuous_data) <- paste0("z_score.", colnames(scaled_continuous_data))

# combine the scaled data to the main dataset 
dat_prob_cut <- cbind(dat_prob_cut, scaled_continuous_data)

colnames(dat_prob_cut)
```

# Logistic regression

## Loop

```{r logistic regression loop}
logistic.stats.outcome <- list() #create empty list to store the information in

for (i in 1:length(outcome.dependent.logistic))
{ cat(i)
  logistic.formula.outcome <- as.formula(sprintf("%s ~ class_reordered_cut", outcome.dependent.logistic[i]))

  logistic.reg.outcome <- glm(logistic.formula.outcome, data = dat_prob_cut, family = "binomial")

  logistic.output.outcome.full <- broom::tidy(logistic.reg.outcome, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1),] %>%
    dplyr::rename(
           OR = estimate,
           OR.conf.low = conf.low,
           OR.conf.high = conf.high)
 
  if (i < 12) {
    logistic.output.outcome.full <- logistic.output.outcome.full %>%
      mutate(block = "Mental health block") %>%
      mutate(Variable = outcome.dependent.logistic.name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 11)) # change depending if we combine a few variables 
  } else {
   logistic.output.outcome.full <- logistic.output.outcome.full %>%
      mutate(block = "Employment block") %>%
      mutate(Variable = outcome.dependent.logistic.name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.value)
  }
  
   logistic.output.outcome.full <- logistic.output.outcome.full %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  logistic.stats.outcome[[i]] <- logistic.output.outcome.full
}

# set the names of the list to match the variable names
names(logistic.stats.outcome) <- outcome.dependent.logistic
```

```{r combine logistic dataframes}
data.outcome.logistic <- data.table::rbindlist(logistic.stats.outcome) %>%
  mutate(Class = rep(c("Increasing", "Decreasing"), 12)) %>% # Create new formatted class variable
  select(Class,
         `Dependent variable` = Variable,
         OR,
         OR.conf.low,
         OR.conf.high,
         p.value, 
         p.value.adjusted,
         Significance,
         block)
```

```{r logistic regression outcome plot}
outcome.logistic.separate.plot <- ggplot(
  data.outcome.logistic, 
  aes(x = `Dependent variable`,
      y = OR,
      ymin = OR.conf.low,
      ymax = OR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "OR (95% CI)",
       x = "names",
       title = "Association between class membership and outcomes at age 18",
       subtitle = paste("N(Total) = ", length(dat_prob_cut$sex),
                        "; N(Increasing) = ", sum(!is.na(dat_prob_cut$class_renamed[dat_prob_cut$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat_prob_cut$class_renamed[dat_prob_cut$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.2,0.4,0.6,0.8, 1, 1.5, 2, 2.5, 3, 4, 5)) +
  coord_flip()

outcome.logistic.separate.plot

#save
ggsave(
  "sensitivity_prob_cut0.8_logistic_outcome_individual_regressions.png",
  plot = outcome.logistic.separate.plot,
  device = "png",
  path = paste0(graph_save_data_path, "outcomes/sensitivity"),
  width = 10,
  height = 7
)
```

# Linear regression using  scores

## Loop with z scores

```{r linear regression loop with z scores}
linear.stats.outcome.zscore <- list() #create empty list to store the information in

for (i in 1:length(outcome.dependent.linear.zscore))
{ cat(i)
  linear.formula.outcome.zscore <- as.formula(sprintf("%s ~ class_reordered_cut", outcome.dependent.linear.zscore[i]))

  linear.reg.outcome.zscore <- lm(linear.formula.outcome.zscore, data = dat_prob_cut)

  linear.output.outcome.full.zscore <- broom::tidy(linear.reg.outcome.zscore, conf.int = TRUE, conf.level = 0.95)[-c(1),] 
 
  if (i < 8) {
    linear.output.outcome.full.zscore <- linear.output.outcome.full.zscore %>%
      mutate(block = "Mental health block") %>%
      mutate(Variable = outcome.dependent.linear.name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 18))
  } else if (i < 12 ) {
   linear.output.outcome.full.zscore <- linear.output.outcome.full.zscore %>%
      mutate(block = "Physical health block") %>%
      mutate(Variable = outcome.dependent.linear.name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  } else if (i < 17) {
    linear.output.outcome.full.zscore <- linear.output.outcome.full.zscore %>%
      mutate(block = "Coping and functioning block") %>%
      mutate(Variable = outcome.dependent.linear.name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 5))
  } else {
    linear.output.outcome.full.zscore <- linear.output.outcome.full.zscore %>%
      mutate(block = "Employment block") %>%
      mutate(Variable = outcome.dependent.linear.name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 5))
  }
  
   linear.output.outcome.full.zscore <- linear.output.outcome.full.zscore %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  linear.stats.outcome.zscore[[i]] <- linear.output.outcome.full.zscore
}
# set the names of the list to match the variable names
names(linear.stats.outcome.zscore) <- outcome.dependent.linear.zscore
```

```{r combine linear dataframes zscore}
data.outcome.linear.zscore <- data.table::rbindlist(linear.stats.outcome.zscore) %>%
  mutate(Class = rep(c("Increasing", "Decreasing"), 20)) %>% # Create new formatted class variable
  select(Class,
         `Dependent variable` = Variable,
         estimate,
         conf.low,
         conf.high,
         p.value, 
         p.value.adjusted,
         Significance,
         block)
```

## Linear regression plot using z scores

```{r linear regression outcome plot zscores}
outcome.linear.separate.plot.zscore <- ggplot(
  data.outcome.linear.zscore, # CHANGE DEPENDING IF YOU WANT TO USE Z SCORES OR NOT - remember to rename the plot if you change it
  aes(x = `Dependent variable`,
      y = estimate,
      ymin = conf.low,
      ymax = conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "Standardised Estimate (95% CI)",
       x = "names",
       title = "Association between childhood social isolation class membership and outcomes at age 18",
       subtitle = paste("N(Total) = ", length(dat_prob_cut$sex),
                        "; N(Increasing) = ", sum(!is.na(dat_prob_cut$class_renamed[dat_prob_cut$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat_prob_cut$class_renamed[dat_prob_cut$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 0) +
 scale_y_continuous(breaks=c(-1.5, -1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1, 1.5, 2)) + 
  coord_flip()

outcome.linear.separate.plot.zscore

#save
ggsave(
  "sensitivity_prob_cut0.8_linear_outcome_individual_regressions_zscore.png",
  plot = outcome.linear.separate.plot.zscore,
  device = "png",
  path = paste0(graph_save_data_path, "outcomes/sensitivity"),
  width = 12,
  height = 9
)
```
















