---
title: "Analyses for testing the association betwween isolation trajectories and outcomes - Three trajectories"
author: "Katherine N Thompson"
date: "19th Jan 2021"
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
    number_sections: no
    highlight: monochrome
    theme: cerulean
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE)

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment}
remove(list = ls())
```

```{r colour palletes for graphs}
palette2 <- c("#78D9C5","#F5BE5E")
palette2b <- c("#78D9C5","#EEB6E9")
```

```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(skimr)
library(ggpubr)
library(tidyr)
library(gplots)
library(Rmisc)
library(MplusAutomation)
library(stringr)
library(stringi)
library(filesstrings)
library(texreg)
library(relimp)
library(nnet)
library(ggplot2)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path}
#source raw data directory: data_raw and data included
source("../../../../../isolation_trajectories_data_path.R")
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat <- readRDS(file = paste0(data_path, "class_joined_preprocessed_isolation_data_full_sample.rds"))
colnames(dat)
```

## List of variables

```{r variable character lists, include=FALSE}
antecedent.independent.numeric <- c("SES_binary_releveled_numeric",
                                    "acorn_continuous_05",
                                    "vandalism_05",
                                    "problems_neighbours_05",
                                    "number_children_school_05",
                                    "number_children_school_free_meals_05",
                                    "child_harm_recoded_numeric_05",
                                    "total_siblings_05",
                                    "total_social_support_05",
                                    "total_activities_with_mum_05",
                                    "mum_notlived_biodad_sincebirth_numeric_05",
                                    "any_domestic_violence_numeric_05",
                                    "maternal_warmth_continuous_05",
                                    "maternal_depression_lifetime_numeric_05",
                                    "maternal_personality_openness_05",
                                    "maternal_personality_conscientiousness_05",
                                    "maternal_personality_extroversion_05",
                                    "maternal_personality_agreeableness_05",
                                    "maternal_personality_neuroticism_05",
                                    "antisocial_behaviour_parent_05",
                                    "alcoholism_parent_05", # kept in for correlaiton heat map
                                    "IQ_05",
                                    "executive_function_05",
                                    "theory_of_mind_05",
                                    "externalising_combined_05",
                                    "internalising_combined_excl_sis_05",
                                    "ADHD_combined_05",
                                    "prosocial_behaviours_combined_05")

name.list.numeric <- c("SES: Low",
                       "ACORN", 
                       "Vandalism", 
                       "Problems with neighbours", 
                       "Number of children in school", 
                       "Number of children eligible for free school meals",
                       "Child harm: Harmed",
                       "Total siblings",
                       "Social support", 
                       "Total activities with mum",
                       "Mum not lived with biological dad since birth: Yes", 
                       "Any domestic violence: Yes",
                       "Maternal warmth",
                       "Maternal lifetime depression: Yes",
                       "Maternal personality: Openness",
                       "Maternal personality: Conscientiousness",
                       "Maternal personality: Extroversion",
                       "Maternal personality: Agreeableness",
                       "Maternal personality: Neuroticism",
                       "Parental antisocial behaviour",
                       "Parental alcoholism", # kept in for correlation matrix
                       "Child IQ",
                       "Child executive function",
                       "Child theory of mind",
                       "Child externalising behaviours",
                       "Child internalising behaviours",
                       "Child ADHD behaviours",
                       "Child prosocial behaviours")
                                 
name.list <- c("SES: Low",
               "ACORN", 
               "Vandalism", 
               "Problems with neighbours", 
               "Number of children in school", 
               "Number of children eligible for free school meals",
               "Child harm: Harmed",
               "Total siblings",
               "Social support", 
               "Total activities with mum",
               "Mum not lived with biological dad since birth: Yes", 
               "Any domestic violence: Yes",
               "Maternal warmth",
               "Maternal lifetime depression: Yes",
               "Maternal personality: Openness",
               "Maternal personality: Conscientiousness",
               "Maternal personality: Extroversion",
               "Maternal personality: Agreeableness",
               "Maternal personality: Neuroticism",
               "Parental antisocial behaviour",
          #     "Parental alcoholism",
               "Child IQ",
               "Child executive function",
               "Child theory of mind",
               "Child externalising behaviours",
               "Child internalising behaviours",
               "Child ADHD behaviours",
               "Child prosocial behaviours")
```

# Theme for plotting

```{r theme for all plots}
theme.antecedent <- theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9),
        axis.text.y = element_text(colour = "black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom",
        strip.text.y = element_blank())
```

# Test for multicollinearity 
Create correlation matrix to look for variables that are highly correlated.
Here parental antisocial behaviour and parental alcoholism have a correlation of 0.94 (Pearson). *Parental alcoholism has been excluded.*

```{r test for multicollinearity,}
# create data frame with just numeric antecedent variables
antececent_data_frame <- as.data.frame(dat[,antecedent.independent.numeric])
colnames(antececent_data_frame) <- name.list.numeric

# get correlation matrix
isolation_cor_matrix <- cor(antececent_data_frame, method = "pearson", use = "complete.obs")

reorder_cor_matrix <- function(cor_matrix){
 dd <- as.dist((1-cor_matrix)/2) #Use correlation between variables as distance
 hc <- hclust(dd)
 cormat <-cor_matrix[hc$order, hc$order]
 }

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(isolation_cor_matrix)
  
#melt the values
metled_cor_matrix <- reshape::melt(cor_matrix_full, na.rm = TRUE)

#correlation heat map
correlation_heat_map <- ggplot(metled_cor_matrix, aes(X2, X1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Pearson\nCorrelation") +
  theme_minimal() +
  labs(y = "",
       x = "",
       title = "Correlation heat map for antecedents")+
 theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
       axis.text.y = element_text(size = 12),
       plot.margin=grid::unit(c(0,0,0,0), "mm"),
       plot.title = element_text(size = 20),
       )+
 coord_fixed() +
  geom_text(aes(X2, X1, label = round(value, digits = 2)), color = "black", size = 3)

correlation_heat_map

#save
ggsave(
  "antecedent_correlation_heat_map.png",
  plot = correlation_heat_map,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 15,
  height = 15
)
```

# Antecedent regression analyses

Decided that 40 variables is too many to include. Variables that have been dropped for the 3 class analysis (those that aren't adding anything):
multinom.class_size_average_05, multinom.resident_moves_05, multinom.temp_negative_affect_05, multinom.temp_impulsivity_05, multinom.temp_approach_05, multinom.temp_sluggishness_05, multinom.temp_wariness_05, multinom.temp_undercontrolled_05, multinom.temp_inhibited_05, multinom.temp_shy_05. 
Combining separate mum and dad variables into "parent": alcoholism, antisocial behaviour - this has been done in regression_variable_preparation script. 

ANALYSIS PLAN 

1. **Individual antecedent regressions**: single regressions are computed for each variable (class ~ variable). This is done through a loop. Relative Risk Ratios (RRR) and their confidence intervals are calculated. Statistics for all variables are combined and RRR (95% CI) are plotted for the Increasing and Decreasing class. FDR multiple testing correction is accounted for independent tests in each block: Social block = 6 tests, Home block = 7 tests, Parent block = 8, Child neurodevelopment block = 3 tests, Child emotional/behavioural development = 4 tests.

2. **Block antecedent regressions**: All variables that significantly predicted class membership are taken forward to be included in a model including all variables from that block. E.g. all "Child neurodevelopment" block variables are analyzed together in the same model (class ~ neuro_variable_1 + neuro_variable_2 + neuro_variable_3). RRR (95% CI) are calculated. Z scores for continuous variables are used. Currently, no FDR correction is applied at this step. 

3. **Full model**: All variables that significantly predict class membership with other block variables controlled for, are taken forward to be included in the full antecedent model. E.g. (class ~ social_variable_1 + home_variable_2 + neuro_variable_3 + emo_variable_4). RRR (95% CI) are calculated. Z scores for continuous variables are used. Currently, no FDR correction is applied at this step.

## Antecedent regression loop for ALL variables - variables are either treated as continuous or binary

The below creates a tibble table for each regression in the list "antecedent.independent" and stores it in the list "multinom.stats.cont". Archived code is stored in "regression_CUTOUTS.Rmd"
Binary variables: SES (middle/high vs low), Child harm (No harm vs possible/definite), any domestic violence (Yes/No), maternal lifetime depression (Yes/No). 
ACORN (1-5) and maternal warmth (1-6) have been recoded to be continuous variables.

The RRR of a coefficient indicates how the risk of the outcome falling in the comparison group compared to the risk of the outcome falling in the referent group changes with the variable in question. An RRR > 1 indicates that the risk of the outcome falling in the comparison group relative to the risk of the outcome falling in the referent group increases as the variable increases.  In other words, the comparison outcome is more likely. An RRR < 1 indicates that the risk of the outcome falling in the comparison group relative to the risk of the outcome falling in the referent group decreases as the variable increases. See the interpretations of the relative risk ratios below for examples.  In general, if the RRR < 1, the outcome is more likely to be in the referent group.

```{r create mlogit STATA file}
# data.mlogit <- dat %>% # need to rename for stata format
#   select(id,
#          familyid,
#          sex,
#          classreordered = class_reordered,
#          ses = SES_binary_releveled, 
#          acorn = z_score.acorn_continuous_05,
#          vandalism = z_score.vandalism_05,
#          probneighbours = z_score.problems_neighbours_05,
#          numberchildschool = z_score.number_children_school_05,
#          meals = z_score.number_children_school_free_meals_05,
#          harm = child_harm_recoded_05, 
#          siblings = z_score.total_siblings_05,
#          socialsupport = z_score.total_social_support_05,
#          activities = z_score.total_activities_with_mum_05,
#          biodad = mum_notlived_biodad_sincebirth_05,
#          domesticviolence = any_domestic_violence_05,
#          maternalwarmth = z_score.maternal_warmth_continuous_05,
#          maternaldepression = maternal_depression_lifetime_05,
#          openness = z_score.maternal_personality_openness_05,
#          conscientiousness = z_score.maternal_personality_conscientiousness_05,
#          extroversion = z_score.maternal_personality_extroversion_05,
#          agreeableness = z_score.maternal_personality_agreeableness_05,
#          neuroticism = z_score.maternal_personality_neuroticism_05,
#          antisocial = z_score.antisocial_behaviour_parent_05,
#          iq = z_score.IQ_05,
#          execfunction = z_score.executive_function_05,
#          theoryofmind = z_score.theory_of_mind_05,
#          externalising = z_score.externalising_combined_05,
#          internalising = z_score.internalising_combined_excl_sis_05,
#          adhd = z_score.ADHD_combined_05,
#          prosocial = z_score.prosocial_behaviours_combined_05)

# library(foreign)
# write.dta(data.mlogit, "/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation trajectories_Paper 1/data_analysis/data_full/data_raw/multinom.reg.stata.dta")
```

# Run STATA file and save the txt output for each regression

```{r run stata do file from r}
# # run stata file
library(RStata)

# options("RStata.StataPath" = "/Applications/Stata/StataMP.app/Contents/MacOS/stata-mp")
# options("RStata.StataVersion" = 16)
# stata("antecedent_multinomial_regression.do", data.out = FALSE)

# move txt file to data file 
# file.move(paste0(stata_data_path, "multinomial_results_si.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path, "multinomial_results_si.socialblock.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path, "multinomial_results_si.homeblock.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path, "multinomial_results_si.parentblock.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path, "multinomial_results_si.neuroblock.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.emoblock.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.fullmodel.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.allmodel.txt"), data_path, overwrite = TRUE)

# individual regressions
dat.stata.individual.raw <- read_tsv(paste0(data_path, "multinomial_results_si.txt")) %>%
  select(results_ses,
         results_acorn:results_prosocial) # order to match name.list order

# social block
dat.stata.social.raw <- read_tsv(paste0(data_path, "multinomial_results_si.socialblock.txt"))
# home block
dat.stata.home.raw <- read_tsv(paste0(data_path, "multinomial_results_si.homeblock.txt"))
# parent block
dat.stata.parent.raw <- read_tsv(paste0(data_path, "multinomial_results_si.parentblock.txt"))
# neuro block
dat.stata.neuro.raw <- read_tsv(paste0(data_path, "multinomial_results_si.neuroblock.txt"))
# emo block
dat.stata.emo.raw <- read_tsv(paste0(data_path, "multinomial_results_si.emoblock.txt"))
# full model
dat.stata.full.raw <- read_tsv(paste0(data_path, "multinomial_results_si.fullmodel.txt"))
# all model
dat.stata.all.raw <- read_tsv(paste0(data_path, "multinomial_results_si.allmodel.txt"))
```

# Reformat data frames

 - b/min95/max95/p is the layout from STATA
 - Have not included FDR correction here

## Individual regressions 

```{r reformat stata data frame}
dat.stata.individual <- dat.stata.individual.raw[c(116:223,229:336),] %>%
  `colnames<-`(name.list) %>%
  mutate(Class =
    case_when(
    row_number() < 109 ~ "Increasing",
    row_number() > 108 ~ "Decreasing")) %>%
  mutate(Variable = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 54)) %>%
  gather(key, value, `SES: Low`:`Child prosocial behaviours`, factor_key = TRUE) %>%
  drop_na() %>%
  spread(Variable, value) %>%
  rename(Variable = key) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  mutate(
    block = 
      case_when(row_number() < 7 ~ "Social block",
                row_number() < 14 ~ "Home block",
                row_number() < 21 ~ "Parent block",
                row_number() < 24 ~ "Neuro block",
                row_number() < 28 ~ "Emo/behave block",
                row_number() < 34 ~ "Social block",
                row_number() < 41 ~ "Home block",
                row_number() < 48 ~ "Parent block",
                row_number() < 51 ~ "Neuro block",
                row_number() > 50 ~ "Emo/behave block")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r table for stata coefficients}
kable(dat.stata.individual)
```

## bind *z score* trasformed values to order the graph according to block of variables

```{r bind and order rows stata}
# social
dat.stata.individual.social <- filter(dat.stata.individual, block == "Social block") %>% 
  arrange(desc(RRR)) 

dat.stata.individual.social$Variable <- factor(dat.stata.individual.social$Variable, levels = paste(unique(paste(dat.stata.individual.social$Variable)), sep = ","))

#home
dat.stata.individual.home <- filter(dat.stata.individual, block == "Home block") %>% 
  arrange(desc(RRR)) 

dat.stata.individual.home$Variable <- factor(dat.stata.individual.home$Variable,levels = paste(unique(paste(dat.stata.individual.home$Variable)),sep = ","))

#parent
dat.stata.individual.parent <- filter(dat.stata.individual, block == "Parent block") %>% 
  arrange(desc(RRR))

dat.stata.individual.parent$Variable <- factor(dat.stata.individual.parent$Variable,levels = paste(unique(paste(dat.stata.individual.parent$Variable)),sep = ","))

#neuro
dat.stata.individual.neuro <- filter(dat.stata.individual, block == "Neuro block") %>% 
  arrange(desc(RRR))

dat.stata.individual.neuro$Variable <- factor(dat.stata.individual.neuro$Variable,levels = paste(unique(paste(dat.stata.individual.neuro$Variable)),sep = ","))

#emo/behave
dat.stata.individual.emo <- filter(dat.stata.individual, block == "Emo/behave block") %>% 
  arrange(desc(RRR))

dat.stata.individual.emo$Variable <- factor(dat.stata.individual.emo$Variable,levels = paste(unique(paste(dat.stata.individual.emo$Variable)),sep = ","))

# all
dat.stata.individual.ordered <- rbind(
  dat.stata.individual.social,
  dat.stata.individual.home,
  dat.stata.individual.parent,
  dat.stata.individual.neuro,
  dat.stata.individual.emo
)
```

## plot of individual regressions

```{r stata plot to be used for results}
stata.plot.individual <- ggplot(
  dat.stata.individual.ordered, 
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
      # title = "Association between antecedents and social isolation class membership",
      # subtitle = paste("N(Total) = ", length(dat$sex),
                       # "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                       # "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
 scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.4,0.6,0.8, 1, 1.5, 2, 2.5, 3, 3.5, 4)) +
  coord_flip()

stata.plot.individual

#save
ggsave(
  "STATA_All_antecedents_individual_regressions_using_zscores.png",
  plot = stata.plot.individual,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/final"),
  width = 13,
  height = 9
)
```
## reformat social block 
```{r reformat stata data frame social block}
dat.stata.social <- dat.stata.social.raw[c(24:39,45:60),] %>%
  mutate(Class =
    case_when(
    row_number() < 17 ~ "Increasing",
    row_number() > 16 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 8)) %>%
  mutate(block = c("Social block")) %>%
  mutate(Variable =
    case_when(row_number() < 5 ~ "SES: Low",
              row_number() < 9 ~ "ACORN",
              row_number() < 13 ~ "Problems with neighbours",
              row_number() < 17 ~ "Number of children eligible for free school meals",
              row_number() < 21 ~ "SES: Low",
              row_number() < 25 ~ "ACORN",
              row_number() < 29 ~ "Problems with neighbours",
              row_number() > 28 ~ "Number of children eligible for free school meals")) %>%
  select(-X1) %>%
  spread(key, socialblock) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r table for stata social block}
kable(dat.stata.social)
```

```{r social block plot - zscores - stata}
social_block.plot.stata <- ggplot(
  dat.stata.social,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Social antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.7,0.8,0.9,1, 1.5, 2, 2.5, 3)) +
  coord_flip()

social_block.plot.stata

#save
ggsave(
  "STATA_social_block_zscores.png",
  plot = social_block.plot.stata,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 4
)
```
## reformat home block

```{r reformat stata data frame home block}
dat.stata.home <- dat.stata.home.raw[c(36:63,69:96),] %>%
  mutate(Class =
    case_when(
    row_number() < 29 ~ "Increasing",
    row_number() > 28 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 14)) %>%
  mutate(block = c("Home block")) %>%
  mutate(Variable =
    case_when(row_number() < 5 ~ "Child harm: Harmed" ,
              row_number() < 9 ~ "Total siblings" ,
              row_number() < 13 ~ "Social support",
              row_number() < 17 ~ "Total activities with mum",
              row_number() < 21 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 25 ~ "Any domestic violence: Yes",
              row_number() < 29 ~ "Maternal warmth",
              row_number() < 33 ~ "Child harm: Harmed" ,
              row_number() < 37 ~ "Total siblings" ,
              row_number() < 41 ~ "Social support",
              row_number() < 45 ~ "Total activities with mum",
              row_number() < 49 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 53 ~ "Any domestic violence: Yes",
              row_number() > 52 ~ "Maternal warmth")) %>%
  select(-X1) %>%
  spread(key, homeblock) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r home block plot - zscores - stata}
home_block.plot.stata <- ggplot(
  dat.stata.home,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Social antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.7,0.8,0.9,1, 1.5, 2, 2.5, 3)) +
  coord_flip()

home_block.plot.stata

#save
ggsave(
  "STATA_home_block_zscores.png",
  plot = home_block.plot.stata,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 4
)
```
# reformat parent block 

```{r reformat stata data frame parent block}
dat.stata.parent <- dat.stata.parent.raw[c(36:63,69:96),] %>%
  mutate(Class =
    case_when(
    row_number() < 29 ~ "Increasing",
    row_number() > 28 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 14)) %>%
  mutate(block = c("Parent block")) %>%
  mutate(Variable =
    case_when(row_number() < 5 ~ "Maternal lifetime depression: Yes",
              row_number() < 9 ~ "Maternal personality: Openness",
              row_number() < 13 ~ "Maternal personality: Conscientiousness",
              row_number() < 17 ~ "Maternal personality: Extroversion",
              row_number() < 21 ~ "Maternal personality: Agreeableness",
              row_number() < 25 ~ "Maternal personality: Neuroticism",
              row_number() < 29 ~ "Parental antisocial behaviour",
              row_number() < 33 ~ "Maternal lifetime depression: Yes" ,
              row_number() < 37 ~ "Maternal personality: Openness",
              row_number() < 41 ~ "Maternal personality: Conscientiousness",
              row_number() < 45 ~ "Maternal personality: Extroversion",
              row_number() < 49 ~ "Maternal personality: Agreeableness",
              row_number() < 53 ~ "Maternal personality: Neuroticism",
              row_number() > 52 ~ "Parental antisocial behaviour")) %>%
  select(-X1) %>%
  spread(key, parentblock) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r parent block plot - zscores - stata}
parent_block.plot.stata <- ggplot(
  dat.stata.parent,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Social antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.7,0.8,0.9,1, 1.5, 2, 2.5, 3)) +
  coord_flip()

parent_block.plot.stata

#save
ggsave(
  "STATA_parent_block_zscores.png",
  plot = parent_block.plot.stata,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 4
)
```
## reformat neuro block

```{r reformat stata data frame neuro block}
dat.stata.neuro <- dat.stata.neuro.raw[c(20:31,37:48),] %>%
  mutate(Class =
    case_when(
    row_number() < 13 ~ "Increasing",
    row_number() > 12 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 6)) %>%
  mutate(block = c("Neuro block")) %>%
  mutate(Variable =
    case_when(row_number() < 5 ~ "Child IQ",
              row_number() < 9 ~ "Child executive function",
              row_number() < 13 ~ "Child theory of mind",
              row_number() < 17 ~ "Child IQ",
              row_number() < 21 ~ "Child executive function",
              row_number() > 20 ~ "Child theory of mind")) %>%
  select(-X1) %>%
  spread(key, neuroblock) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r neuro block plot - zscores - stata}
neuro_block.plot.stata <- ggplot(
  dat.stata.neuro,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Social antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.7,0.8,0.9,1, 1.5, 2, 2.5, 3)) +
  coord_flip()

neuro_block.plot.stata

#save
ggsave(
  "STATA_neuro_block_zscores.png",
  plot = neuro_block.plot.stata,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 4
)
```
## reformat emo block

```{r reformat stata data frame emo block}
dat.stata.emo <- dat.stata.emo.raw[c(24:39,45:60),] %>%
  mutate(Class =
    case_when(
    row_number() < 17 ~ "Increasing",
    row_number() > 16 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 8)) %>%
  mutate(block = c("Emo/behave block")) %>%
  mutate(Variable =
    case_when(row_number() < 5 ~ "Child externalising behaviours",
              row_number() < 9 ~ "Child internalising behaviours" ,
              row_number() < 13 ~ "Child ADHD behaviours",
              row_number() < 17 ~ "Child prosocial behaviours" ,
              row_number() < 21 ~ "Child externalising behaviours",
              row_number() < 25 ~ "Child internalising behaviours" ,
              row_number() < 29 ~ "Child ADHD behaviours",
              row_number() > 28 ~ "Child prosocial behaviours")) %>%
  select(-X1) %>%
  spread(key, emoblock) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r emo block plot - zscores - stata}
emo_block.plot.stata <- ggplot(
  dat.stata.emo,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Social antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.7,0.8,0.9,1, 1.5, 2, 2.5, 3)) +
  coord_flip()

emo_block.plot.stata

#save
ggsave(
  "STATA_emo_block_zscores.png",
  plot = emo_block.plot.stata,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 4
)
```
## reformat full model (only sig variables)

```{r reformat stata data full frame}
dat.stata.full <- dat.stata.full.raw[c(60:111,117:168),] %>%
  mutate(Class =
    case_when(
    row_number() < 53 ~ "Increasing",
    row_number() > 52 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 26)) %>%
  mutate(Variable =
    case_when(row_number() < 5  ~ "SES: Low",
              row_number() < 9  ~ "Number of children eligible for free school meals",
              row_number() < 13 ~ "Child harm: Harmed",
              row_number() < 17 ~ "Total activities with mum",
              row_number() < 21 ~ "Maternal warmth",
              row_number() < 25 ~ "Maternal personality: Conscientiousness",
              row_number() < 29 ~ "Parental antisocial behaviour",
              row_number() < 33 ~ "Child IQ",
              row_number() < 37 ~ "Child executive function",
              row_number() < 41 ~ "Child theory of mind",
              row_number() < 45 ~ "Child internalising behaviours" ,
              row_number() < 49 ~ "Child ADHD behaviours",
              row_number() < 53 ~ "Child prosocial behaviours",
              row_number() < 57 ~ "SES: Low",
              row_number() < 61 ~ "Number of children eligible for free school meals",
              row_number() < 65 ~ "Child harm: Harmed",
              row_number() < 69 ~ "Total activities with mum",
              row_number() < 73 ~ "Maternal warmth",
              row_number() < 77 ~ "Maternal personality: Conscientiousness",
              row_number() < 81 ~ "Parental antisocial behaviour",
              row_number() < 85 ~ "Child IQ",
              row_number() < 89 ~ "Child executive function",
              row_number() < 93 ~ "Child theory of mind",
              row_number() < 97 ~ "Child internalising behaviours" ,
              row_number() < 101 ~ "Child ADHD behaviours",
              row_number() > 100 ~ "Child prosocial behaviours")) %>%
  select(-X1) %>%
  mutate(
    block = case_when(
              row_number() < 9  ~ "Social block",
              row_number() < 21 ~ "Home block",
              row_number() < 29 ~ "Parent block",
              row_number() < 41 ~ "Neuro block",
              row_number() < 53 ~ "Emo/behave block",
              row_number() < 61 ~ "Social block",
              row_number() < 73 ~ "Home block",
              row_number() < 81 ~ "Parent block",
              row_number() < 93 ~ "Neuro block",
              row_number() > 92 ~ "Emo/behave block")) %>%
  spread(key, fullmodel) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```


```{r stata plot full model}
stata.plot.full_model <- ggplot(
  dat.stata.full, 
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       title = "Association between antecedents and social isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
 scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.6,0.8, 1, 1.5, 2)) +
  coord_flip()

stata.plot.full_model 

#save
ggsave(
  "STATA_full_model_antecedents_zscores.png",
  plot = stata.plot.full_model,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/final"),
  width = 12,
  height = 9
)
```

## reformat all model (all variables included in one single model) 

```{r reformat stata data all model}
dat.stata.all <- dat.stata.all.raw[c(116:223,229:336),] %>%
  mutate(Class =
    case_when(
    row_number() < 109 ~ "Increasing",
    row_number() > 108 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 54)) %>%
  mutate(Variable =
    case_when(row_number() < 5  ~ "SES: Low",
              row_number() < 9  ~ "ACORN",
              row_number() < 13 ~ "Vandalism",
              row_number() < 17 ~ "Problems with neighbours",
              row_number() < 21 ~ "Number of children in school",
              row_number() < 25 ~ "Number of children eligible for free school meals",
              row_number() < 29 ~ "Child harm: Harmed",
              row_number() < 33 ~ "Total siblings",
              row_number() < 37 ~ "Social support",
              row_number() < 41 ~ "Total activities with mum",
              row_number() < 45 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 49 ~ "Any domestic violence: Yes" ,
              row_number() < 53 ~ "Maternal warmth",
              row_number() < 57 ~ "Maternal lifetime depression: Yes",
              row_number() < 61 ~ "Maternal personality: Openness",
              row_number() < 65 ~ "Maternal personality: Conscientiousness",
              row_number() < 69 ~ "Maternal personality: Extroversion",
              row_number() < 73 ~ "Maternal personality: Agreeableness",
              row_number() < 77 ~ "Maternal personality: Neuroticism",
              row_number() < 81 ~ "Parental antisocial behaviour",
              row_number() < 85 ~ "Child IQ",
              row_number() < 89 ~ "Child executive function",
              row_number() < 93 ~ "Child theory of mind",
              row_number() < 97 ~ "Child externalising behaviours" ,
              row_number() < 101 ~ "Child internalising behaviours",
              row_number() < 105 ~ "Child ADHD behaviours",
              row_number() < 109 ~ "Child prosocial behaviours",
              row_number() < 113  ~ "SES: Low",
              row_number() < 117  ~ "ACORN",
              row_number() < 121 ~ "Vandalism",
              row_number() < 125 ~ "Problems with neighbours",
              row_number() < 129 ~ "Number of children in school",
              row_number() < 133 ~ "Number of children eligible for free school meals",
              row_number() < 137 ~ "Child harm: Harmed",
              row_number() < 141 ~ "Total siblings",
              row_number() < 145 ~ "Social support",
              row_number() < 149 ~ "Total activities with mum",
              row_number() < 153 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 157 ~ "Any domestic violence: Yes" ,
              row_number() < 161 ~ "Maternal warmth",
              row_number() < 165 ~ "Maternal lifetime depression: Yes",
              row_number() < 169 ~ "Maternal personality: Openness",
              row_number() < 173 ~ "Maternal personality: Conscientiousness",
              row_number() < 177 ~ "Maternal personality: Extroversion",
              row_number() < 181 ~ "Maternal personality: Agreeableness",
              row_number() < 185 ~ "Maternal personality: Neuroticism",
              row_number() < 189 ~ "Parental antisocial behaviour",
              row_number() < 193 ~ "Child IQ",
              row_number() < 197 ~ "Child executive function",
              row_number() < 201 ~ "Child theory of mind",
              row_number() < 205 ~ "Child externalising behaviours" ,
              row_number() < 209 ~ "Child internalising behaviours",
              row_number() < 213 ~ "Child ADHD behaviours",
              row_number() > 212 ~ "Child prosocial behaviours")) %>%
  select(-X1) %>%
  mutate(
    block = case_when(
              row_number() < 25  ~ "Social block",
              row_number() < 53 ~ "Home block",
              row_number() < 81 ~ "Parent block",
              row_number() < 93 ~ "Neuro block",
              row_number() < 109 ~ "Emo/behave block",
              row_number() < 133 ~ "Social block",
              row_number() < 161 ~ "Home block",
              row_number() < 189 ~ "Parent block",
              row_number() < 201 ~ "Neuro block",
              row_number() > 200 ~ "Emo/behave block")) %>%
  spread(key, allmodel) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            block = block) 
```

```{r stata all table}
kable(dat.stata.all)
```

```{r stata plot full model}
stata.plot.all_model <- ggplot(
  dat.stata.all, 
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       title = "Association between antecedents and social isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
 scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.6,0.8, 1, 1.5, 2)) +
  coord_flip()

stata.plot.all_model 

#save
ggsave(
  "STATA_All_model_antecedents_zscores.png",
  plot = dat.stata.all,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/final"),
  width = 12,
  height = 9
)
```
