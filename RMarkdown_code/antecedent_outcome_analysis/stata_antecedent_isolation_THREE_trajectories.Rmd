---
title: "Analyses for testing the association betwween isolation trajectories and outcomes - Three trajectories"
author: "Katherine N Thompson"
date: "19th Jan 2021"
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
    number_sections: no
    highlight: monochrome
    theme: cerulean
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE)

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment}
remove(list = ls())
```

```{r colour palletes for graphs}
palette2 <- c("#78D9C5","#F5BE5E")
palette2b <- c("#78D9C5","#EEB6E9")
```

```{r Load packages}
library(summarytools)
library(MplusAutomation)
library(filesstrings)
library(nnet)
library(ggplot2)
library(knitr)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path}
#source raw data directory: data_raw and data included
source("../../../../../isolation_trajectories_data_path.R")
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat <- readRDS(file = paste0(data_path, "class_joined_preprocessed_isolation_data_full_sample.rds"))
colnames(dat)
```

## List of variables

```{r variable character lists, include=FALSE}
antecedent.independent.numeric <- c("SES_binary_releveled_numeric",
                                    "acorn_continuous_05",
                                    "vandalism_05",
                                    "problems_neighbours_05",
                                    "number_children_school_05",
                                    "number_children_school_free_meals_05",
                                    "child_harm_recoded_numeric_05",
                                    "total_siblings_05",
                                    "total_social_support_05",
                                    "total_activities_with_mum_05",
                                    "mum_notlived_biodad_sincebirth_numeric_05",
                                    "any_domestic_violence_numeric_05",
                                    "maternal_warmth_continuous_05",
                                    "maternal_depression_lifetime_numeric_05",
                                    "maternal_personality_openness_05",
                                    "maternal_personality_conscientiousness_05",
                                    "maternal_personality_extroversion_05",
                                    "maternal_personality_agreeableness_05",
                                    "maternal_personality_neuroticism_05",
                                    "antisocial_behaviour_parent_05",
                                    "alcoholism_parent_05", 
                                    "IQ_05",
                                    "executive_function_05",
                                    "theory_of_mind_05",
                                    "externalising_combined_05",
                                    "internalising_combined_excl_sis_05",
                                    "ADHD_combined_05",
                                    "prosocial_behaviours_combined_05")

antecedent.independent.continuous <- c("acorn_continuous_05",
                                      "vandalism_05",
                                      "problems_neighbours_05",
                                      "number_children_school_05",
                                      "number_children_school_free_meals_05",
                                      "total_siblings_05",
                                      "total_social_support_05",
                                      "total_activities_with_mum_05",
                                      "maternal_warmth_continuous_05",
                                      "maternal_personality_openness_05",
                                      "maternal_personality_conscientiousness_05",
                                      "maternal_personality_extroversion_05",
                                      "maternal_personality_agreeableness_05",
                                      "maternal_personality_neuroticism_05",
                                      "antisocial_behaviour_parent_05",
                                      "alcoholism_parent_05",
                                      "IQ_05",
                                      "executive_function_05",
                                      "theory_of_mind_05",
                                      "externalising_combined_05",
                                      "internalising_combined_excl_sis_05",
                                      "ADHD_combined_05",
                                      "prosocial_behaviours_combined_05")
                                 
name.list <- c("SES: Low",
               "ACORN", 
               "Vandalism", 
               "Problems with neighbours", 
               "Number of children in school", 
               "Number of children eligible for free school meals",
               "Child harm: Harmed",
               "Total siblings",
               "Social support", 
               "Total activities with mum",
               "Mum not lived with biological dad since birth: Yes", 
               "Any domestic violence: Yes",
               "Maternal warmth",
               "Maternal lifetime depression: Yes",
               "Maternal personality: Openness",
               "Maternal personality: Conscientiousness",
               "Maternal personality: Extroversion",
               "Maternal personality: Agreeableness",
               "Maternal personality: Neuroticism",
               "Parental antisocial behaviour", 
               "Parental alcoholism", 
               "Child IQ",
               "Child executive function",
               "Child theory of mind",
               "Child externalising behaviours",
               "Child internalising behaviours",
               "Child ADHD behaviours",
               "Child prosocial behaviours")
```

# Script functions 
- multiple.testing()
- paper.table()
- order.variables()

```{r script functions}
multiple.testing <- function(data, class, method = "BH", n.tests){
  data <- data %>%
    filter(Class == class) %>%
  mutate(
    p.value.adjusted = 
           stats::p.adjust(p.value, 
                    method = method,
                    n = n.tests) 
  ) %>%
  mutate(Significance.adjusted = 
           if_else(
            p.value.adjusted < 0.05, 
            1,
            0
      ) %>%
        recode_factor(
          `1` = "Significant",
          `0` = "Non-significant")
         )  
  return(data)
}

paper.table <- function(data){
  
  table <- data %>%
  arrange(match(Domain, c("Social domain", "Home domain", "Parent domain", "Neuro domain", "Emo/behave domain"))) %>%
  select(
    Class,
    Variable,
    RRR,
    `95% CI low` = RRR.conf.low,
    `95% CI high` = RRR.conf.high,
    `p value` = p.value,
    Domain,
    -Significance) %>%
  kable(digits = 2)
  
  return(table)
}

order.variables <- function(data, domain){
  data <- filter(data, Domain == domain) %>%
    arrange(desc(RRR))
  
  data$Variable <- factor(data$Variable, 
                          levels = paste(unique(paste(data$Variable)), sep = ","))
  return(data)
}
```

# Theme for plotting

```{r theme for all plots}
theme.antecedent <- theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
                          plot.title = element_text(size = 12,face = "bold"),
                          plot.subtitle = element_text(hjust = 0.5),
                          axis.title.x = element_text(size = 10, face = "bold"),
                          axis.title.y = element_blank(),
                          axis.text.x = element_text(size = 8, colour = "black"),
                          axis.text.y = element_text(colour = "black", size = 10),
                          axis.ticks.x = element_blank(),
                          axis.ticks.y = element_blank(),
                          panel.background = element_blank(),
                          legend.position = "bottom",
                          strip.text.y = element_blank(),
                          strip.text.x = element_text(size = 10, color = "black", face = "bold"),
                          strip.background = element_rect(color = "black", fill = "white", size = 0.5, linetype = "solid")                    
  )
```

# Test for multicollinearity 

Create correlation matrix to look for variables that are highly correlated.
On previous graph: parental antisocial behaviour and parental alcoholism have a correlation of 0.94 (Pearson).
When rerunning the analyses - their correlation is 0.62 - therefore there must have been a previous error in deriving the parental alcoholism variable. 
*parental alcoholism has been reentered into the regressions*

```{r test for multicollinearity,}
# create data frame with just numeric antecedent variables
antececent_data_frame <- as.data.frame(dat[,antecedent.independent.numeric])
colnames(antececent_data_frame) <- name.list

# get correlation matrix
isolation_cor_matrix <- cor(antececent_data_frame, method = "pearson", use = "pairwise.complete.obs")

reorder_cor_matrix <- function(cor_matrix){
 dd <- as.dist((1-cor_matrix)/2) #Use correlation between variables as distance
 hc <- hclust(dd)
 cormat <-cor_matrix[hc$order, hc$order]
 }

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(isolation_cor_matrix)
  
#melt the values
metled_cor_matrix <- reshape::melt(cor_matrix_full, na.rm = TRUE)

#correlation heat map
correlation_heat_map <- ggplot(metled_cor_matrix, aes(X2, X1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Pearson\nCorrelation") +
  theme_minimal() +
  labs(y = "",
       x = "",
       title = "Correlation heat map for antecedents")+
 theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
       axis.text.y = element_text(size = 12),
       plot.margin=grid::unit(c(0,0,0,0), "mm"),
       plot.title = element_text(size = 20),
       )+
 coord_fixed() +
  geom_text(aes(X2, X1, label = round(value, digits = 2)), color = "black", size = 3)

correlation_heat_map
```

```{r save heatmap}
ggsave(
  "antecedent_correlation_heat_map.png",
  plot = correlation_heat_map,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 15,
  height = 15
)
```

# Posterior sensitivity analysis 

## Posterior probability indicator

*IMPORTANT* 
When posterior.cut is set to TRUE the following chunks will run for the data set that has those probability<0.8 dropped.  
*IMPORTANT* 

```{r posterior probability indicator}
posterior.cut = TRUE
```

```{r posterior probability code}
if(posterior.cut == TRUE){

# create new variable only with those who have a probability higher than 0.8 for each class
dat <- dat %>%
  mutate(class_renamed_cut =
           factor(
             case_when(
             prob2 > 0.8 & class_renamed == "Increasing" ~ "Increasing",
             prob3 > 0.8 & class_renamed == "Decreasing" ~ "Decreasing",
             prob1 > 0.8 & class_renamed == "Low stable" ~ "Low stable"
           ), 
           ordered = FALSE))

library(nnet)
# check the biggest group in the class to be the reference group
table(dat$class_renamed_cut)

# relevel class_factor
dat <- dat %>% 
  mutate(
    class_reordered_cut =
      relevel(
        class_renamed_cut,
        ref = "Low stable",
        first = TRUE, #levels in ref come first
        collapse = "+", #String used when constructing names for combined factor levels
        xlevels = TRUE #levels maintained even if not actually occurring
        
      )
  )
# check
table(dat$class_reordered_cut)

# create new data set with only these individuals
dat_prob_cut_out <- dat %>% filter(is.na(class_reordered_cut))
dat <- dat %>% filter(!is.na(class_reordered_cut))

# check
freq(dat$class_reordered)
}
```

```{r descriptives for probabilites}
if(posterior.cut == TRUE){
low.stable.cut.stats <- dat_prob_cut_out %>%
  filter(class_reordered == "Low stable") %>%
  descr(prob1)

increasing.cut.stats <- dat_prob_cut_out %>%
  filter(class_reordered == "Increasing") %>%
  descr(prob2)

decreasing.cut.stats <- dat_prob_cut_out %>%
  filter(class_reordered == "Decreasing") %>%
  descr(prob3)

low.stable.cut.stats
increasing.cut.stats
decreasing.cut.stats
}
```

Low stable: Dropped 42 people. Average probability = 0.66, minimum probability = 0.48. 
Increasing: Dropped 24 people. Average probability = 0.64, minimum probability = 0.49.
Decreasing: Dropped 25 people. Average probability = 0.63, minimum probability = 0.51.
NEW N = 2141 


# Antecedent regression analyses

Forty variables was con variables is too many to include. 
Variables that have been dropped for the 3 class analysis:
multinom.class_size_average_05, multinom.resident_moves_05, multinom.temp_negative_affect_05, multinom.temp_impulsivity_05, multinom.temp_approach_05, multinom.temp_sluggishness_05, multinom.temp_wariness_05, multinom.temp_undercontrolled_05, multinom.temp_inhibited_05, multinom.temp_shy_05. 
Combining separate mum and dad variables into "parent": alcoholism, antisocial behaviour - this has been done in regression_variable_preparation script. 

ANALYSIS PLAN 

1. **Individual antecedent regressions**: single regressions are computed for each variable (class ~ variable). This is done through a loop. Relative Risk Ratios (RRR) and their confidence intervals are calculated. Statistics for all variables are combined and RRR (95% CI) are plotted for the Increasing and Decreasing class. 

2. **Full model**: All variables that significantly predict class membership are controlled for. E.g. (class ~ social_variable_1 + home_variable_2 + neuro_variable_3 + emo_variable_4). RRR (95% CI) are calculated. Z scores for continuous variables are used. No multiple testing correction is applied at this step.


## Antecedent regression loop for ALL variables - variables are either treated as continuous or binary

The below creates a tibble table for each regression in the list "antecedent.independent" and stores it in the list "multinom.stats.cont". Archived code is stored in "regression_CUTOUTS.Rmd"

Binary variables: SES (middle/high vs low), Child harm (No harm vs possible/definite), any domestic violence (Yes/No), maternal lifetime depression (Yes/No). 
ACORN (1-5) and maternal warmth (1-6) have been recoded to be continuous variables.

The RRR coefficient indicates the likelihood of having higher values on the variable of interest, for those following either the increasing and decreasing class compared to the low stable. 

# Create *z scores* for all continuous variables

```{r scale continuous variables and combine to main dataset}
# create a scaled version of the continuous variables - z scores for all variables
scaled_continuous_data <- as.data.frame(scale(dat[antecedent.independent.continuous], center = TRUE, scale = TRUE))

# rename variables to show that they are z scores 
colnames(scaled_continuous_data) <- paste0("z_score.", colnames(scaled_continuous_data))

# combine the scaled data to the main dataset 
dat <- cbind(dat, scaled_continuous_data)
```

```{r create mlogit STATA file}
data.mlogit <- dat %>% # need to rename for stata format
  select(id,
         familyid,
         sex,
         classreordered = class_reordered,
         ses = SES_binary_releveled,
         acorn = z_score.acorn_continuous_05,
         vandalism = z_score.vandalism_05,
         probneighbours = z_score.problems_neighbours_05,
         numberchildschool = z_score.number_children_school_05,
         meals = z_score.number_children_school_free_meals_05,
         harm = child_harm_recoded_05,
         siblings = z_score.total_siblings_05,
         socialsupport = z_score.total_social_support_05,
         activities = z_score.total_activities_with_mum_05,
         biodad = mum_notlived_biodad_sincebirth_05,
         domesticviolence = any_domestic_violence_05,
         maternalwarmth = z_score.maternal_warmth_continuous_05,
         maternaldepression = maternal_depression_lifetime_05,
         openness = z_score.maternal_personality_openness_05,
         conscientiousness = z_score.maternal_personality_conscientiousness_05,
         extroversion = z_score.maternal_personality_extroversion_05,
         agreeableness = z_score.maternal_personality_agreeableness_05,
         neuroticism = z_score.maternal_personality_neuroticism_05,
         antisocial = z_score.antisocial_behaviour_parent_05,
         alcohol = z_score.alcoholism_parent_05,
         iq = z_score.IQ_05,
         execfunction = z_score.executive_function_05,
         theoryofmind = z_score.theory_of_mind_05,
         externalising = z_score.externalising_combined_05,
         internalising = z_score.internalising_combined_excl_sis_05,
         adhd = z_score.ADHD_combined_05,
         prosocial = z_score.prosocial_behaviours_combined_05)
```

## Write data files for STATA to be used in multinomial regression

Want to save two different files depending on if we've cut the sample or not. 

```{r write STATA file for multinom}
library(foreign)
if(posterior.cut == FALSE){
  write.dta(data.mlogit, "/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation trajectories_Paper 1/data_analysis/data_full/data_raw/multinom.reg.stata.dta")
}

if(posterior.cut == TRUE){
  write.dta(data.mlogit, "/Users/katiethompson/Documents/PhD/LISS-DTP_Louise_and_Tim/Social isolation trajectories_Paper 1/data_analysis/data_full/data_raw/multinom.reg.stata.POSTERIOR.dta")
}
```

# Run STATA file and save the txt output for each regression

*Go into STATA and run the file "antecedent_multinomial_regression.do" or "antecedent_multinomial_regression_POSTERIOR.do"*. The output will then be saved in a txt file for all the regressions run. 

Three models were run in STATA:
1. Individual regressions. Each antecedent was regressed on class membership. 
2. Significant only regressions. This is the full model of antecedents that only includes variables that were significant at the individual regression stage. 
3. All model. This includes all antecedents in one model predicting class membership. 

The below chunk includes code to move the txt files to the right place - once this has been done the code is hashed out. 

```{r run stata do file from r}
if(posterior.cut == FALSE){
# move txt file to data file 
# file.move(paste0(stata_data_path, "multinomial_results_si.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.allmodel.SIGUNI.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.allmodel.txt"), data_path, overwrite = TRUE)
  
# individual regressions
dat.stata.individual.raw <- read_tsv(paste0(data_path, "multinomial_results_si.txt")) 
# all model with only univariate sig variables
dat.stata.all.siguni.raw <- read_tsv(paste0(data_path, "multinomial_results_si.allmodel.SIGUNI.txt"))
# all model
dat.stata.all.raw <- read_tsv(paste0(data_path, "multinomial_results_si.allmodel.txt"))
}

if(posterior.cut == TRUE){
# move txt file to data file 
# file.move(paste0(stata_data_path, "multinomial_results_si_POSTERIOR.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.allmodel.SIGUNI_POSTERIOR.txt"), data_path, overwrite = TRUE)
# file.move(paste0(stata_data_path,"multinomial_results_si.allmodel_POSTERIOR.txt"), data_path, overwrite = TRUE)

# individual regressions
dat.stata.individual.raw <- read_tsv(paste0(data_path, "multinomial_results_si_POSTERIOR.txt")) 
# all model with only univariate sig variables
dat.stata.all.siguni.raw <- read_tsv(paste0(data_path, "multinomial_results_si.allmodel.SIGUNI_POSTERIOR.txt"))
# all model
dat.stata.all.raw <- read_tsv(paste0(data_path, "multinomial_results_si.allmodel_POSTERIOR.txt"))
}
```

# Reformat STATA data frames 

 - b/min95/max95/p is the layout from STATA. We will now rearrange this file to create the antecedent multinomial tables needed for the paper. 

## Univariate individual regressions 

```{r reformat stata data frame}
dat.stata.individual <- dat.stata.individual.raw[c(120:231,237:348),-c(1)] %>%
  `colnames<-`(name.list) %>%
  mutate(Class =
    case_when(
    row_number() < 113 ~ "Increasing",
    row_number() > 112 ~ "Decreasing")) %>%
  mutate(Variable = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 56)) %>%
  gather(key, value, `SES: Low`:`Child prosocial behaviours`, factor_key = TRUE) %>%
  drop_na() %>%
  spread(Variable, value) %>%
  dplyr::rename(Variable = key) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  mutate(
    block = 
      case_when(row_number() < 7 ~ "Social domain",
                row_number() < 14 ~ "Home domain",
                row_number() < 22 ~ "Parent domain",
                row_number() < 25 ~ "Neuro domain",
                row_number() < 29 ~ "Emo/behave domain",
                row_number() < 35 ~ "Social domain",
                row_number() < 42 ~ "Home domain",
                row_number() < 50 ~ "Parent domain",
                row_number() < 53 ~ "Neuro domain",
                row_number() > 52 ~ "Emo/behave domain")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            Domain = block)
```

```{r table for stata coefficients}
univariate.reg.table <- paper.table(dat.stata.individual)
univariate.reg.table
```

### Check associations applying multiple testing correction

```{r multiple testing correction for univariate associations}
dat.stata.individual.decreasing <- multiple.testing(data = dat.stata.individual,
                                                    class = "Decreasing",
                                                    method = "BH",
                                                    n.tests = 28)      

dat.stata.individual.increasing <- multiple.testing(data = dat.stata.individual,
                                                    class = "Increasing",
                                                    method = "BH",
                                                    n.tests = 28)
dat.stata.individual.fdr <- rbind(
  dat.stata.individual.decreasing,
  dat.stata.individual.increasing
)

kable(dat.stata.individual.fdr, digits = 2)
```

## Multivariate model including variables that were significant in univariate models 

```{r reformat stata data all model uni sig}
dat.stata.all.siguni <- dat.stata.all.siguni.raw[c(112:215,221:324),] %>%
  mutate(Class =
    case_when(
    row_number() < 105 ~ "Increasing",
    row_number() > 104 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 52)) %>%
  mutate(Variable =
    case_when(row_number() < 5  ~ "SES: Low",
              row_number() < 9  ~ "ACORN",
              row_number() < 13 ~ "Problems with neighbours",
              row_number() < 17 ~ "Number of children eligible for free school meals",
              row_number() < 21 ~ "Child harm: Harmed",
              row_number() < 25 ~ "Total siblings",
              row_number() < 29 ~ "Social support",
              row_number() < 33 ~ "Total activities with mum",
              row_number() < 37 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 41 ~ "Any domestic violence: Yes" ,
              row_number() < 45 ~ "Maternal warmth",
              row_number() < 49 ~ "Maternal lifetime depression: Yes",
              row_number() < 53 ~ "Maternal personality: Openness",
              row_number() < 57 ~ "Maternal personality: Conscientiousness",
              row_number() < 61 ~ "Maternal personality: Extroversion",
              row_number() < 65 ~ "Maternal personality: Agreeableness",
              row_number() < 69 ~ "Maternal personality: Neuroticism",
              row_number() < 73 ~ "Parental antisocial behaviour",
              row_number() < 77 ~ "Parental alcoholism",
              row_number() < 81 ~ "Child IQ",
              row_number() < 85 ~ "Child executive function",
              row_number() < 89 ~ "Child theory of mind",
              row_number() < 93 ~ "Child externalising behaviours" ,
              row_number() < 97 ~ "Child internalising behaviours",
              row_number() < 101 ~ "Child ADHD behaviours",
              row_number() < 105 ~ "Child prosocial behaviours",
              row_number() < 109  ~ "SES: Low",
              row_number() < 113  ~ "ACORN",
              row_number() < 117 ~ "Problems with neighbours",
              row_number() < 121 ~ "Number of children eligible for free school meals",
              row_number() < 125 ~ "Child harm: Harmed",
              row_number() < 129 ~ "Total siblings",
              row_number() < 133 ~ "Social support",
              row_number() < 137 ~ "Total activities with mum",
              row_number() < 141 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 145 ~ "Any domestic violence: Yes" ,
              row_number() < 149 ~ "Maternal warmth",
              row_number() < 153 ~ "Maternal lifetime depression: Yes",
              row_number() < 157 ~ "Maternal personality: Openness",
              row_number() < 161 ~ "Maternal personality: Conscientiousness",
              row_number() < 165 ~ "Maternal personality: Extroversion",
              row_number() < 169 ~ "Maternal personality: Agreeableness",
              row_number() < 173 ~ "Maternal personality: Neuroticism",
              row_number() < 177 ~ "Parental antisocial behaviour",
              row_number() < 181 ~ "Parental alcoholism",
              row_number() < 185 ~ "Child IQ",
              row_number() < 189 ~ "Child executive function",
              row_number() < 193 ~ "Child theory of mind",
              row_number() < 197 ~ "Child externalising behaviours" ,
              row_number() < 201 ~ "Child internalising behaviours",
              row_number() < 205 ~ "Child ADHD behaviours",
              row_number() > 204 ~ "Child prosocial behaviours")) %>%
  select(-X1) %>%
  mutate(
    block = case_when(
              row_number() < 17  ~ "Social domain",
              row_number() < 45 ~ "Home domain",
              row_number() < 77 ~ "Parent domain",
              row_number() < 89 ~ "Neuro domain",
              row_number() < 105 ~ "Emo/behave domain",
              row_number() < 121 ~ "Social domain",
              row_number() < 149 ~ "Home domain",
              row_number() < 181 ~ "Parent domain",
              row_number() < 193 ~ "Neuro domain",
              row_number() > 192 ~ "Emo/behave domain")) %>%
  spread(key, pallmodelsiguni) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            Domain = block)
```

```{r stata all table}
multivariate.siguni.reg.table <- paper.table(dat.stata.all.siguni)
multivariate.siguni.reg.table
```

## Reformat univariate and multivariate data to create a graph containing both information 

### Add in "significance" variable to distinguish between univariate and multivariate significance

```{r add in if the variable was significant in multivariate analysis}
dat.stata.all.siguni.sig <- dat.stata.all.siguni %>%
  select(Class,
         Variable,
         full.significance = Significance)

dfs <- list(dat.stata.individual,
            dat.stata.all.siguni.sig)

individual.and.multi.sig <- plyr::join_all(dfs, by = c("Variable", 
                                                 "Class"))

individual.and.multi.sig <- individual.and.multi.sig %>%
  mutate(overall.significance = 
              case_when(full.significance == "Significant" ~ "Multivariate significant",
                        Significance == "Significant" ~ "Non-significant",
                        TRUE ~ "Non-significant")) %>%
  select(Class,
         Variable,
         RRR,
         RRR.conf.low,
         RRR.conf.high,
         p.value,
         Significance,
         Domain,
         full.significance,
         overall.significance)

individual.and.multi.sig$overall.significance <- factor(individual.and.multi.sig$overall.significance, 
                                                        levels = c("Multivariate significant", 
                                                                   "Non-significant"))
```

### Bind *z score* trasformed values to order the graph according to block of variables

```{r bind and order rows for the plot}
individual.and.multi.sig.social <- order.variables(data = individual.and.multi.sig, domain = "Social domain")
individual.and.multi.sig.home <- order.variables(data = individual.and.multi.sig, domain = "Home domain")
individual.and.multi.sig.parent <- order.variables(data = individual.and.multi.sig, domain = "Parent domain")
individual.and.multi.sig.neuro <- order.variables(data = individual.and.multi.sig, domain = "Neuro domain")
individual.and.multi.sig.emo <- order.variables(data = individual.and.multi.sig, domain = "Emo/behave domain")

# join all
dat.stata.individual.ordered <- rbind(
  individual.and.multi.sig.social,
  individual.and.multi.sig.home,
  individual.and.multi.sig.parent,
  individual.and.multi.sig.neuro,
  individual.and.multi.sig.emo
)
```

# Plot for univariate regressions 

## With significant multivariate associations indicated - OPTION 1

```{r stata plot to be used for results OPTION 1}
stata.plot.individual.OPTION1 <- ggplot(
  dat.stata.individual.ordered, 
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,)
  ) +
  scale_fill_manual(values = "black") +
  scale_color_manual(values = "black") +
  scale_shape_manual(values = c(8, 19)) +
  geom_pointrange(aes(shape = overall.significance),position = position_dodge(width = 0.7), 
                  show.legend = FALSE, 
                  size = 0.5) +
 facet_grid(Domain ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
 scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.4,0.6,0.8, 1, 1.5, 2, 2.5, 3, 3.5, 4)) +
  coord_flip() 
  
stata.plot.individual.OPTION1
```
## No significance indicators - OPTION 2

```{r stata plot to be used for results OPTION 2}
stata.plot.individual.OPTION2 <- ggplot(
  dat.stata.individual.ordered, 
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,)
  ) +
  scale_fill_manual(values = "black") +
  scale_color_manual(values = "black") +
  scale_shape_manual(values = c(19)) +
  geom_pointrange(position = position_dodge(width = 0.7), 
                  show.legend = FALSE, 
                  size = 0.5) +
 facet_grid(Domain ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
 scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.4,0.6,0.8, 1, 1.5, 2, 2.5, 3, 3.5, 4)) +
  coord_flip() 
  
stata.plot.individual.OPTION2
```

```{r save final antecedent plot}
if(posterior.cut == FALSE){
#save
ggsave(
  "STATA_All_antecedents_individual_regressions_using_zscores_final.png",
  plot = stata.plot.individual.OPTION2,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/final"),
  width = 11,
  height = 6.5
)
}
```

# Multivariate model with all variables included

```{r reformat stata data all model}
dat.stata.all <- dat.stata.all.raw[c(120:231,237:348),] %>%
  mutate(Class =
    case_when(
    row_number() < 113 ~ "Increasing",
    row_number() > 112 ~ "Decreasing")) %>%
  mutate(key = 
           rep(c("RRR", "RRR.conf.low", "RRR.conf.high", "p.value"), 56)) %>%
  mutate(Variable =
    case_when(row_number() < 5  ~ "SES: Low",
              row_number() < 9  ~ "ACORN",
              row_number() < 13 ~ "Vandalism",
              row_number() < 17 ~ "Problems with neighbours",
              row_number() < 21 ~ "Number of children in school",
              row_number() < 25 ~ "Number of children eligible for free school meals",
              row_number() < 29 ~ "Child harm: Harmed",
              row_number() < 33 ~ "Total siblings",
              row_number() < 37 ~ "Social support",
              row_number() < 41 ~ "Total activities with mum",
              row_number() < 45 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 49 ~ "Any domestic violence: Yes" ,
              row_number() < 53 ~ "Maternal warmth",
              row_number() < 57 ~ "Maternal lifetime depression: Yes",
              row_number() < 61 ~ "Maternal personality: Openness",
              row_number() < 65 ~ "Maternal personality: Conscientiousness",
              row_number() < 69 ~ "Maternal personality: Extroversion",
              row_number() < 73 ~ "Maternal personality: Agreeableness",
              row_number() < 77 ~ "Maternal personality: Neuroticism",
              row_number() < 81 ~ "Parental antisocial behaviour",
              row_number() < 85 ~ "Parental alcoholism",
              row_number() < 89 ~ "Child IQ",
              row_number() < 93 ~ "Child executive function",
              row_number() < 97 ~ "Child theory of mind",
              row_number() < 101 ~ "Child externalising behaviours" ,
              row_number() < 105 ~ "Child internalising behaviours",
              row_number() < 109 ~ "Child ADHD behaviours",
              row_number() < 113 ~ "Child prosocial behaviours",
              row_number() < 117  ~ "SES: Low",
              row_number() < 121  ~ "ACORN",
              row_number() < 125 ~ "Vandalism",
              row_number() < 129 ~ "Problems with neighbours",
              row_number() < 133 ~ "Number of children in school",
              row_number() < 137 ~ "Number of children eligible for free school meals",
              row_number() < 141 ~ "Child harm: Harmed",
              row_number() < 145 ~ "Total siblings",
              row_number() < 149 ~ "Social support",
              row_number() < 153 ~ "Total activities with mum",
              row_number() < 157 ~ "Mum not lived with biological dad since birth: Yes",
              row_number() < 161 ~ "Any domestic violence: Yes" ,
              row_number() < 165 ~ "Maternal warmth",
              row_number() < 169 ~ "Maternal lifetime depression: Yes",
              row_number() < 173 ~ "Maternal personality: Openness",
              row_number() < 177 ~ "Maternal personality: Conscientiousness",
              row_number() < 181 ~ "Maternal personality: Extroversion",
              row_number() < 185 ~ "Maternal personality: Agreeableness",
              row_number() < 189 ~ "Maternal personality: Neuroticism",
              row_number() < 193 ~ "Parental antisocial behaviour",
              row_number() < 197 ~ "Parental alcoholism",
              row_number() < 201 ~ "Child IQ",
              row_number() < 205 ~ "Child executive function",
              row_number() < 209 ~ "Child theory of mind",
              row_number() < 213 ~ "Child externalising behaviours" ,
              row_number() < 217 ~ "Child internalising behaviours",
              row_number() < 221 ~ "Child ADHD behaviours",
              row_number() > 220 ~ "Child prosocial behaviours")) %>%
  select(-X1) %>%
  mutate(
    block = case_when(
              row_number() < 25  ~ "Social domain",
              row_number() < 53 ~ "Home domain",
              row_number() < 85 ~ "Parent domain",
              row_number() < 97 ~ "Neuro domain",
              row_number() < 113 ~ "Emo/behave domain",
              row_number() < 137 ~ "Social domain",
              row_number() < 165 ~ "Home domain",
              row_number() < 197 ~ "Parent domain",
              row_number() < 209 ~ "Neuro domain",
              row_number() > 208 ~ "Emo/behave domain")) %>%
  spread(key, pallmodel) %>%
  mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant")) %>%
  transmute(Class = Class,
            Variable = Variable,
            RRR = as.numeric(RRR),
            RRR.conf.low = as.numeric(RRR.conf.low),
            RRR.conf.high = as.numeric(RRR.conf.high),
            p.value = as.numeric(p.value),
            Significance = Significance,
            Domain = block) 
```

## Table

```{r stata all table}
paper.table.all.variables <- paper.table(dat.stata.all)
paper.table.all.variables
```

```{r bind and order rows for the sgdp centre plot}
dat.stata.all.plot <- dat.stata.all %>% 
  filter(Significance == "Significant",
         Variable != "Child executive function")

individual.and.multi.sig.social.plot <- order.variables(data = dat.stata.all.plot, domain = "Social domain")
individual.and.multi.sig.parent.plot <- order.variables(data = dat.stata.all.plot, domain = "Parent domain")
individual.and.multi.sig.emo.plot <- order.variables(data = dat.stata.all.plot, domain = "Emo/behave domain")

# join all
dat.stata.all.plot.ordered <- rbind(
  individual.and.multi.sig.social.plot,
  individual.and.multi.sig.parent.plot,
  individual.and.multi.sig.emo.plot
)
```

## Plot

```{r stata plot full model}
stata.plot.all_model <- ggplot(
  dat.stata.all.plot.ordered, 
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(Domain ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       title = "Association between antecedents and social isolation trajectories",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  theme(legend.position = "none") +
  geom_hline(linetype = "dashed", yintercept = 1) +
 scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.5, 0.6,0.8, 1, 1.5, 2, 2.5, 3, 4)) +
  coord_flip()

stata.plot.all_model 
```

```{r save multivariate plot}
if(posterior.cut == FALSE){
#save
ggsave(
  "multivariate_antecedent_STATA_SGDP_CENTRE.png",
  plot = stata.plot.all_model,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/"),
  width = 8,
  height = 3
)
}
```

