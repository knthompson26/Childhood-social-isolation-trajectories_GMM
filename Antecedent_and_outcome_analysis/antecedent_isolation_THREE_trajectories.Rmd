---
title: "Analyses for testing the association betwween isolation trajectories and outcomes - Three trajectories"
author: "Katherine N Thompson"
date: "19th Jan 2021"
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
    number_sections: no
    highlight: monochrome
    theme: cerulean
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE)

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment}
remove(list = ls())
```

```{r colour palletes for graphs}
palette2 <- c("#78D9C5","#F5BE5E")
palette2b <- c("#78D9C5","#EEB6E9")
```

```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(skimr)
library(ggpubr)
library(tidyr)
library(gplots)
library(Rmisc)
library(MplusAutomation)
library(stringr)
library(stringi)
library(filesstrings)
library(texreg)
library(relimp)
library(nnet)
library(ggplot2)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path}
#source raw data directory: data_raw and data included
source("../../../isolation_trajectories_data_path.R")
```

```{r read in prepped regression data and check variable names, include=FALSE}
dat <- readRDS(file = paste0(data_path, "regression_data_THREE_traj.rds"))
colnames(dat)
```

## List of variables

```{r variable character lists, include=FALSE}
antecedent.independent.numeric <- c("SES_binary_releveled_numeric",
                                    "acorn_continuous_05",
                                    "vandalism_05",
                                    "problems_neighbours_05",
                                    "number_children_school_05",
                                    "number_children_school_free_meals_05",
                                    "child_harm_recoded_numeric_05",
                                    "total_siblings_05",
                                    "total_social_support_05",
                                    "total_activities_with_mum_05",
                                    "mum_notlived_biodad_sincebirth_numeric_05",
                                    "any_domestic_violence_numeric_05",
                                    "maternal_warmth_continuous_05",
                                    "maternal_depression_lifetime_numeric_05",
                                    "maternal_personality_openness_05",
                                    "maternal_personality_conscientiousness_05",
                                    "maternal_personality_extroversion_05",
                                    "maternal_personality_agreeableness_05",
                                    "maternal_personality_neuroticism_05",
                                    "antisocial_behaviour_parent_05",
                                    "alcoholism_parent_05", # kept in for correlaiton heat map
                                    "IQ_05",
                                    "executive_function_05",
                                    "theory_of_mind_05",
                                    "externalising_combined_05",
                                    "internalising_combined_excl_sis_05",
                                    "ADHD_combined_05",
                                    "prosocial_behaviours_combined_05")

name.list.numeric <- c("SES: Low",
                       "ACORN", 
                       "Vandalism", 
                       "Problems with neighbours", 
                       "Number of children in school", 
                       "Number of children eligible for free school meals",
                       "Child harm: Harmed",
                       "Total siblings",
                       "Social support", 
                       "Total activities with mum",
                       "Mum not lived with biological dad since birth: Yes", 
                       "Any domestic violence: Yes",
                       "Maternal warmth",
                       "Maternal lifetime depression: Yes",
                       "Maternal personality: Openness",
                       "Maternal personality: Conscientiousness",
                       "Maternal personality: Extroversion",
                       "Maternal personality: Agreeableness",
                       "Maternal personality: Neuroticism",
                       "Parental antisocial behaviour",
                       "Parental alcoholism", # kept in for correlation matrix
                       "Child IQ",
                       "Child executive function",
                       "Child theory of mind",
                       "Child externalising behaviours",
                       "Child internalising behaviours",
                       "Child ADHD behaviours",
                       "Child prosocial behaviours")

antecedent.independent.continuous <- c("acorn_continuous_05",
                                      "vandalism_05",
                                      "problems_neighbours_05",
                                      "number_children_school_05",
                                      "number_children_school_free_meals_05",
                                      "total_siblings_05",
                                      "total_social_support_05",
                                      "total_activities_with_mum_05",
                                      "maternal_warmth_continuous_05",
                                      "maternal_personality_openness_05",
                                      "maternal_personality_conscientiousness_05",
                                      "maternal_personality_extroversion_05",
                                      "maternal_personality_agreeableness_05",
                                      "maternal_personality_neuroticism_05",
                                      "antisocial_behaviour_parent_05",
                                  #    "alcoholism_parent_05",
                                      "IQ_05",
                                      "executive_function_05",
                                      "theory_of_mind_05",
                                      "externalising_combined_05",
                                      "internalising_combined_excl_sis_05",
                                      "ADHD_combined_05",
                                      "prosocial_behaviours_combined_05")

antecedent.independent.continuous.loop <- c("z_score.acorn_continuous_05",
                                            "z_score.vandalism_05",
                                            "z_score.problems_neighbours_05",
                                            "z_score.number_children_school_05",
                                            "z_score.number_children_school_free_meals_05",
                                            "z_score.total_siblings_05",
                                            "z_score.total_social_support_05",
                                            "z_score.total_activities_with_mum_05",
                                            "z_score.maternal_warmth_continuous_05",
                                            "z_score.maternal_personality_openness_05",
                                            "z_score.maternal_personality_conscientiousness_05",
                                            "z_score.maternal_personality_extroversion_05",
                                            "z_score.maternal_personality_agreeableness_05",
                                            "z_score.maternal_personality_neuroticism_05",
                                            "z_score.antisocial_behaviour_parent_05",
                                      #      "z_score.alcoholism_parent_05",
                                            "z_score.IQ_05",
                                            "z_score.executive_function_05",
                                            "z_score.theory_of_mind_05",
                                            "z_score.externalising_combined_05",
                                            "z_score.internalising_combined_excl_sis_05",
                                            "z_score.ADHD_combined_05",
                                            "z_score.prosocial_behaviours_combined_05")

name.list.continuous.loop <- c("ACORN", 
                               "Vandalism", 
                               "Problems with neighbours", 
                               "Number of children in school", 
                               "Number of children eligible for free school meals",
                               "Total siblings",
                               "Social support", 
                               "Total activities with mum",
                               "Maternal warmth",
                               "Maternal personality: Openness",
                               "Maternal personality: Conscientiousness",
                               "Maternal personality: Extroversion",
                               "Maternal personality: Agreeableness",
                               "Maternal personality: Neuroticism",
                               "Parental antisocial behaviour",
                          #     "Parental alcoholism",
                               "Child IQ",
                               "Child executive function",
                               "Child theory of mind",
                               "Child externalising behaviours",
                               "Child internalising behaviours",
                               "Child ADHD behaviours",
                               "Child prosocial behaviours")

antecedent.independent <- c("SES_binary_releveled",
                            "acorn_continuous_05",
                            "vandalism_05",
                            "problems_neighbours_05",
                            "number_children_school_05",
                            "number_children_school_free_meals_05",
                            "child_harm_recoded_05",
                            "total_siblings_05",
                            "total_social_support_05",
                            "total_activities_with_mum_05",
                            "mum_notlived_biodad_sincebirth_05",
                            "any_domestic_violence_05",
                            "maternal_warmth_continuous_05",
                            "maternal_depression_lifetime_05",
                            "maternal_personality_openness_05",
                            "maternal_personality_conscientiousness_05",
                            "maternal_personality_extroversion_05",
                            "maternal_personality_agreeableness_05",
                            "maternal_personality_neuroticism_05",
                            "antisocial_behaviour_parent_05",
                       #     "alcoholism_parent_05",
                            "IQ_05",
                            "executive_function_05",
                            "theory_of_mind_05",
                            "externalising_combined_05",
                            "internalising_combined_excl_sis_05",
                            "ADHD_combined_05",
                            "prosocial_behaviours_combined_05")
                                 
name.list <- c("SES: Low",
               "ACORN", 
               "Vandalism", 
               "Problems with neighbours", 
               "Number of children in school", 
               "Number of children eligible for free school meals",
               "Child harm: Harmed",
               "Total siblings",
               "Social support", 
               "Total activities with mum",
               "Mum not lived with biological dad since birth: Yes", 
               "Any domestic violence: Yes",
               "Maternal warmth",
               "Maternal lifetime depression: Yes",
               "Maternal personality: Openness",
               "Maternal personality: Conscientiousness",
               "Maternal personality: Extroversion",
               "Maternal personality: Agreeableness",
               "Maternal personality: Neuroticism",
               "Parental antisocial behaviour",
          #     "Parental alcoholism",
               "Child IQ",
               "Child executive function",
               "Child theory of mind",
               "Child externalising behaviours",
               "Child internalising behaviours",
               "Child ADHD behaviours",
               "Child prosocial behaviours")
```

# Theme for plotting

```{r theme for all plots}
theme.antecedent <- theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9),
        axis.text.y = element_text(colour = "black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom",
        strip.text.y = element_blank())
```

# Test for multicollinearity 
Create correlation matrix to look for variables that are highly correlated.
Here parental antisocial behaviour and parental alcoholism have a correlation of 0.94 (Pearson). *Parental alcoholism has been excluded.*

```{r test for multicollinearity,}
# create data frame with just numeric antecedent variables
antececent_data_frame <- as.data.frame(dat[,antecedent.independent.numeric])
colnames(antececent_data_frame) <- name.list.numeric

# get correlation matrix
isolation_cor_matrix <- cor(antececent_data_frame, method = "pearson", use = "complete.obs")

reorder_cor_matrix <- function(cor_matrix){
 dd <- as.dist((1-cor_matrix)/2) #Use correlation between variables as distance
 hc <- hclust(dd)
 cormat <-cor_matrix[hc$order, hc$order]
 }

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(isolation_cor_matrix)
  
#melt the values
metled_cor_matrix <- reshape::melt(cor_matrix_full, na.rm = TRUE)

#correlation heat map
correlation_heat_map <- ggplot(metled_cor_matrix, aes(X2, X1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Pearson\nCorrelation") +
  theme_minimal() +
  labs(y = "",
       x = "",
       title = "Correlation heat map for antecedents")+
 theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
       axis.text.y = element_text(size = 12),
       plot.margin=grid::unit(c(0,0,0,0), "mm"),
       plot.title = element_text(size = 20),
       )+
 coord_fixed() +
  geom_text(aes(X2, X1, label = round(value, digits = 2)), color = "black", size = 3)

correlation_heat_map

#save
ggsave(
  "antecedent_correlation_heat_map.png",
  plot = correlation_heat_map,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 15,
  height = 15
)
```

# Antecedent regression analyses

Decided that 40 variables is too many to include. Variables that have been dropped for the 3 class analysis (those that aren't adding anything):
multinom.class_size_average_05, multinom.resident_moves_05, multinom.temp_negative_affect_05, multinom.temp_impulsivity_05, multinom.temp_approach_05, multinom.temp_sluggishness_05, multinom.temp_wariness_05, multinom.temp_undercontrolled_05, multinom.temp_inhibited_05, multinom.temp_shy_05. 
Combining separate mum and dad variables into "parent": alcoholism, antisocial behaviour - this has been done in regression_variable_preparation script. 

ANALYSIS PLAN 

1. **Individual antecedent regressions**: single regressions are computed for each variable (class ~ variable). This is done through a loop. Relative Risk Ratios (RRR) and their confidence intervals are calculated. Statistics for all variables are combined and RRR (95% CI) are plotted for the Increasing and Decreasing class. FDR multiple testing correction is accounted for independent tests in each block: Social block = 6 tests, Home block = 7 tests, Parent block = 8, Child neurodevelopment block = 3 tests, Child emotional/behavioural development = 4 tests.

2. **Block antecedent regressions**: All variables that significantly predicted class membership are taken forward to be included in a model including all variables from that block. E.g. all "Child neurodevelopment" block variables are analyzed together in the same model (class ~ neuro_variable_1 + neuro_variable_2 + neuro_variable_3). RRR (95% CI) are calculated. Z scores for continuous variables are used. Currently, no FDR correction is applied at this step. 
3. **Full model**: All variables that significantly predict class membership with other block variables controlled for, are taken forward to be included in the full antecedent model. E.g. (class ~ social_variable_1 + home_variable_2 + neuro_variable_3 + emo_variable_4). RRR (95% CI) are calculated. Z scores for continuous variables are used. Currently, no FDR correction is applied at this step.

Many people use train and test data sets - should we *change this to the test and train data sets? Or test and train the final model?*


## Antecedent regression loop for ALL variables - variables are either treated as continuous or binary

The below creates a tibble table for each regression in the list "antecedent.independent" and stores it in the list "multinom.stats.cont". Archived code is stored in "regression_CUTOUTS.Rmd"
Binary variables: SES (middle/high vs low), Child harm (No harm vs possible/definite), any domestic violence (Yes/No), maternal lifetime depression (Yes/No). 
ACORN (1-5) and maternal warmth (1-6) have been recoded to be continuous variables.

The RRR of a coefficient indicates how the risk of the outcome falling in the comparison group compared to the risk of the outcome falling in the referent group changes with the variable in question. An RRR > 1 indicates that the risk of the outcome falling in the comparison group relative to the risk of the outcome falling in the referent group increases as the variable increases.  In other words, the comparison outcome is more likely. An RRR < 1 indicates that the risk of the outcome falling in the comparison group relative to the risk of the outcome falling in the referent group decreases as the variable increases. See the interpretations of the relative risk ratios below for examples.  In general, if the RRR < 1, the outcome is more likely to be in the referent group.

```{r loop for running antecedent regressions, include=FALSE}
multinom.stats.ant <- list() #create empty list to store the information in

for (i in 1:length(antecedent.independent))
{ cat(i)
  multinom.formula.ant <- as.formula(sprintf("class_reordered ~ %s", antecedent.independent[i]))

  multinom.reg.ant <- multinom(multinom.formula.ant, data = dat)

  multinom.output.ant.full <- broom::tidy(multinom.reg.ant, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,3),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)
 
  if (i < 7) {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Social block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 6))
  } else if (i < 14 ) {
   multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Home block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 21) {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Parent block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 24) {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Neuro block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 3))
  } else {
    multinom.output.ant.full <- multinom.output.ant.full %>%
      mutate(block = "Emo/behave block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  }
  
   multinom.output.ant.full <- multinom.output.ant.full %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  multinom.stats.ant[[i]] <- multinom.output.ant.full
}
# set the names of the list to match the variable names
names(multinom.stats.ant) <- antecedent.independent
```

## Call statistics from loop

```{r call statistics for all antecedent regressions, include=FALSE}
for (i in 1:length(antecedent.independent))
{ 
  assign(paste0("multinom.", names(multinom.stats.ant[i])), as.tibble(multinom.stats.ant[[i]]))
}
```

# Create *z scores* for all continuous variables

```{r scale continuous variables and combine to main dataset}
# create a scaled version of the continuous variables - z scores for all variables
scaled_continuous_data <- as.data.frame(scale(dat[antecedent.independent.continuous], center = TRUE, scale = TRUE))

# rename variables to show that they are z scores 
colnames(scaled_continuous_data) <- paste0("z_score.", colnames(scaled_continuous_data))

# combine the scaled data to the main dataset 
dat <- cbind(dat, scaled_continuous_data)
```

## Create loop using the *z scores* for plotting continuous variables

```{r loop for running antecedent regressions, include=FALSE}
multinom.stats.ant.cont <- list() #create empty list to store the information in

for (i in 1:length(antecedent.independent.continuous.loop))
{ cat(i)
  multinom.formula.ant.cont <- as.formula(sprintf("class_reordered ~ %s", antecedent.independent.continuous.loop[i]))

  multinom.reg.ant.cont <- multinom(multinom.formula.ant.cont, data = dat)

  multinom.output.ant.full.cont <- broom::tidy(multinom.reg.ant.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,3),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)
 
  if (i < 6) {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Social block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 6))
  } else if (i < 10 ) {
   multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Home block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 16) {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Parent block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 19) {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Neuro block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 3))
  } else {
    multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>%
      mutate(block = "Emo/behave block") %>%
      mutate(Variable = name.list.continuous.loop[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  }
  
   multinom.output.ant.full.cont <- multinom.output.ant.full.cont %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  multinom.stats.ant.cont[[i]] <- multinom.output.ant.full.cont
}
# set the names of the list to match the variable names
names(multinom.stats.ant.cont) <- antecedent.independent.continuous.loop
```

```{r call statistics for zscore continuous antecedent regressions, include=FALSE}
for (i in 1:length(antecedent.independent.continuous.loop))
{ 
  assign(paste0("multinom.", names(multinom.stats.ant.cont[i])), as.tibble(multinom.stats.ant.cont[[i]]))
}
```

# Sex differences in individual antecedent regressions 

```{r loop for running antecedent regressions, include=FALSE}
multinom.stats.ant.sex <- list() #create empty list to store the information in

for (i in 1:length(antecedent.independent))
{ cat(i)
  multinom.formula.ant.sex <- as.formula(sprintf("class_reordered ~ %s + sex + sex*%s", antecedent.independent[i], antecedent.independent[i]))

  multinom.reg.ant.sex <- multinom(multinom.formula.ant.sex, data = dat)

  multinom.output.ant.full.sex <- broom::tidy(multinom.reg.ant.sex, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1:3,5:7),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)
 
  if (i < 7) {
    multinom.output.ant.full.sex <- multinom.output.ant.full.sex %>%
      mutate(block = "Social block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 6))
  } else if (i < 14 ) {
   multinom.output.ant.full.sex <- multinom.output.ant.full.sex %>%
      mutate(block = "Home block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 21) {
    multinom.output.ant.full.sex <- multinom.output.ant.full.sex %>%
      mutate(block = "Parent block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 24) {
    multinom.output.ant.full.sex <- multinom.output.ant.full.sex %>%
      mutate(block = "Neuro block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 3))
  } else {
    multinom.output.ant.full.sex <- multinom.output.ant.full.sex %>%
      mutate(block = "Emo/behave block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  }
  
   multinom.output.ant.full.sex <- multinom.output.ant.full.sex %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  multinom.stats.ant.sex[[i]] <- multinom.output.ant.full.sex
}
# set the names of the list to match the variable names
names(multinom.stats.ant.sex) <- antecedent.independent
```

## Call statistics from loop

**No sex differences after accounting for multiple testing**
- No interaction effect between sex and the variable for each class. 

```{r combine all data frames}
data.ant_full.sex <- data.table::rbindlist(multinom.stats.ant.sex)
```

# Zygosity differences in individual antecedent regressions 

```{r loop for running antecedent regressions, include=FALSE}
multinom.stats.ant.zyg <- list() #create empty list to store the information in

for (i in 1:length(antecedent.independent))
{ cat(i)
  multinom.formula.ant.zyg <- as.formula(sprintf("class_reordered ~ %s + zygosity_binary + zygosity_binary*%s", antecedent.independent[i], antecedent.independent[i]))

  multinom.reg.ant.zyg <- multinom(multinom.formula.ant.zyg, data = dat)

  multinom.output.ant.full.zyg <- broom::tidy(multinom.reg.ant.zyg, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1:3,5:7),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)
 
  if (i < 7) {
    multinom.output.ant.full.zyg <- multinom.output.ant.full.zyg %>%
      mutate(block = "Social block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 6))
  } else if (i < 14 ) {
   multinom.output.ant.full.zyg <- multinom.output.ant.full.zyg %>%
      mutate(block = "Home block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 21) {
    multinom.output.ant.full.zyg <- multinom.output.ant.full.zyg %>%
      mutate(block = "Parent block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 7))
  } else if (i < 24) {
    multinom.output.ant.full.zyg <- multinom.output.ant.full.zyg %>%
      mutate(block = "Neuro block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 3))
  } else {
    multinom.output.ant.full.zyg <- multinom.output.ant.full.zyg %>%
      mutate(block = "Emo/behave block") %>%
      mutate(Variable = name.list[[i]]) %>%
                  mutate(p.value.adjusted = p.adjust(p.value, method = "fdr", n = 4))
  }
  
   multinom.output.ant.full.zyg <- multinom.output.ant.full.zyg %>% 
    mutate(
    Significance = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      ))
    
  multinom.stats.ant.zyg[[i]] <- multinom.output.ant.full.zyg
}
# set the names of the list to match the variable names
names(multinom.stats.ant.zyg) <- antecedent.independent
```

## Call statistics from loop

**No zygosity differences after accounting for multiple testing**
- No interaction effect between zygosity and the variable for each class. 

```{r combine all data frames}
data.ant_full.zyg <- data.table::rbindlist(multinom.stats.ant.zyg)
```

# Table including all statistics for individual antecedent regressions

```{r table for all individual regressions}
data.ant_full.table <- data.table::rbindlist(multinom.stats.ant) %>%
  select(Class, 
         Variable, 
         block, 
         RRR, 
         RRR.conf.low, 
         RRR.conf.high, 
         std.error,
         p.value.adjusted,
         Significance)
```

```{r word table of individual antecedent regressions}
kable(data.ant_full.table %>% mutate_if(is.numeric, ~round(., 3)))
```

```{r table for all individual regressions - z score}
data.ant_full.table.cont <- data.table::rbindlist(multinom.stats.ant.cont)
data.ant_full.table.cont <- rbind(data.ant_full.table.cont, 
                                  multinom.SES_binary_releveled, 
                                  multinom.mum_notlived_biodad_sincebirth_05,
                                  multinom.any_domestic_violence_05,
                                  multinom.child_harm_recoded_05,
                                  multinom.maternal_depression_lifetime_05) %>%
  select(Class, 
         Variable, 
         block, 
         RRR, 
         RRR.conf.low, 
         RRR.conf.high, 
         std.error,
         p.value.adjusted,
         Significance)
```

```{r word table of individual antecedent regressions - z scores}
kable(data.ant_full.table.cont %>% mutate_if(is.numeric, ~round(., 3)))
```

# Graph for individual antecedent regressions

## bind non trasformed values

```{r bind and order rows}
# social
data.ant_social.ordered <- filter(data.ant_full.table, block == "Social block") %>% 
  arrange(desc(RRR)) 

data.ant_social.ordered$Variable <- factor(data.ant_social.ordered$Variable, levels = paste(unique(paste(data.ant_social.ordered$Variable)), sep = ","))

#home
data.ant_home.ordered <- filter(data.ant_full.table, block == "Home block") %>% 
  arrange(desc(RRR)) 

data.ant_home.ordered$Variable <- factor(data.ant_home.ordered$Variable,levels = paste(unique(paste(data.ant_home.ordered$Variable)),sep = ","))

#parent
data.ant_parent.ordered <- filter(data.ant_full.table, block == "Parent block") %>% 
  arrange(desc(RRR))

data.ant_parent.ordered$Variable <- factor(data.ant_parent.ordered$Variable,levels = paste(unique(paste(data.ant_parent.ordered$Variable)),sep = ","))

#neuro
data.ant_neuro.ordered <- filter(data.ant_full.table, block == "Neuro block") %>% 
  arrange(desc(RRR))

data.ant_neuro.ordered$Variable <- factor(data.ant_neuro.ordered$Variable,levels = paste(unique(paste(data.ant_neuro.ordered$Variable)),sep = ","))

#emo/behave
data.ant_emo_behave.ordered <- filter(data.ant_full.table, block == "Emo/behave block") %>% 
  arrange(desc(RRR))

data.ant_emo_behave.ordered$Variable <- factor(data.ant_emo_behave.ordered$Variable,levels = paste(unique(paste(data.ant_emo_behave.ordered$Variable)),sep = ","))

# all
data.ant_full.ordered <- rbind(
  data.ant_social.ordered,
  data.ant_home.ordered,
  data.ant_parent.ordered,
  data.ant_neuro.ordered,
  data.ant_emo_behave.ordered
)
```

## bind *z score* trasformed values

```{r bind and order rows}
# social
data.ant_social.ordered.cont <- filter(data.ant_full.table.cont, block == "Social block") %>% 
  arrange(desc(RRR)) 

data.ant_social.ordered.cont$Variable <- factor(data.ant_social.ordered.cont$Variable, levels = paste(unique(paste(data.ant_social.ordered.cont$Variable)), sep = ","))

#home
data.ant_home.ordered.cont <- filter(data.ant_full.table.cont, block == "Home block") %>% 
  arrange(desc(RRR)) 

data.ant_home.ordered.cont$Variable <- factor(data.ant_home.ordered.cont$Variable,levels = paste(unique(paste(data.ant_home.ordered.cont$Variable)),sep = ","))

#parent
data.ant_parent.ordered.cont <- filter(data.ant_full.table.cont, block == "Parent block") %>% 
  arrange(desc(RRR))

data.ant_parent.ordered.cont$Variable <- factor(data.ant_parent.ordered.cont$Variable,levels = paste(unique(paste(data.ant_parent.ordered.cont$Variable)),sep = ","))

#neuro
data.ant_neuro.ordered.cont <- filter(data.ant_full.table.cont, block == "Neuro block") %>% 
  arrange(desc(RRR))

data.ant_neuro.ordered.cont$Variable <- factor(data.ant_neuro.ordered.cont$Variable,levels = paste(unique(paste(data.ant_neuro.ordered.cont$Variable)),sep = ","))

#emo/behave
data.ant_emo_behave.ordered.cont <- filter(data.ant_full.table.cont, block == "Emo/behave block") %>% 
  arrange(desc(RRR))

data.ant_emo_behave.ordered.cont$Variable <- factor(data.ant_emo_behave.ordered.cont$Variable,levels = paste(unique(paste(data.ant_emo_behave.ordered.cont$Variable)),sep = ","))

# all
data.ant_full.ordered.cont <- rbind(
  data.ant_social.ordered.cont,
  data.ant_home.ordered.cont,
  data.ant_parent.ordered.cont,
  data.ant_neuro.ordered.cont,
  data.ant_emo_behave.ordered.cont
)
```

## Plots of individual antecedent regressions

```{r antecedent plot with separated classes}
ant.all.separate.plot.cont <- ggplot(
  data.ant_full.ordered.cont, # CHANGE DEPENDING IF YOU WANT TO USE Z SCORES OR NOT - remember to rename the plot if you change it
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      color = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  facet_grid(block ~ Class, drop = TRUE, scales = "free_y", space = "free") +
  labs(y = "RRR (95% CI)",
       x = "names",
       title = "Association between antecedents and social isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.2,0.4,0.6,0.8, 1, 1.5, 2, 2.5, 3, 4)) +
  coord_flip()

ant.all.separate.plot.cont

#save
ggsave(
  "All_antecedents_individual_regressions_using_zscores.png",
  plot = ant.all.separate.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/final"),
  width = 12,
  height = 9
)
```

# Block regressions

## Social factors

### Non-scaled

```{r social block regression}
multinom.formula.ant.social.block <- as.formula(class_reordered ~ SES_binary_releveled + problems_neighbours_05 + number_children_school_free_meals_05)

multinom.reg.ant.social.block <- multinom(multinom.formula.ant.social.block, data = dat)

multinom.output.ant.social.block <- broom::tidy(multinom.reg.ant.social.block, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,5),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.social.block.full <- multinom.output.ant.social.block %>%
  mutate(Variable = rep(c("SES: Low", "Problems with neighbours","Number of children eligible for free school meals"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05, # have not included FDR correction here
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.social.block.full
```

```{r social block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.social.block.full.ordered <- arrange(multinom.output.ant.social.block.full, desc(RRR))
# Created a leveled factor for the variables
multinom.output.ant.social.block.full.ordered$Variable <- factor(multinom.output.ant.social.block.full.ordered$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.social.block.full.ordered$Variable)),sep = ","))
```

### Scaled (z scores)

```{r social block regression z score}
multinom.formula.ant.social.block.cont <- as.formula(class_reordered ~ SES_binary_releveled + z_score.problems_neighbours_05 + z_score.number_children_school_free_meals_05)

multinom.reg.ant.social.block.cont <- multinom(multinom.formula.ant.social.block.cont, data = dat)

multinom.output.ant.social.block.cont <- broom::tidy(multinom.reg.ant.social.block.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,5),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.social.block.full.cont <- multinom.output.ant.social.block.cont %>%
  mutate(Variable = rep(c("SES: Low", "Problems with neighbours","Number of children eligible for free school meals"),2)) %>%
    mutate(
    Significance = 
      if_else(
        p.value < 0.05, # have not included FDR correction here
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )
  
multinom.output.ant.social.block.full.cont
```

```{r social block graph prep - zscores}
# Arrange to be ordered by OR
multinom.output.ant.social.block.full.ordered.cont <- arrange(multinom.output.ant.social.block.full.cont, desc(RRR))
# Created a leveled factor for the variables
multinom.output.ant.social.block.full.ordered.cont$Variable <- factor(multinom.output.ant.social.block.full.ordered.cont$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.social.block.full.ordered.cont$Variable)),
                                                    sep = ","))
```


```{r social block plot - zscores}
social_block.plot.cont <- ggplot(
  multinom.output.ant.social.block.full.ordered.cont,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Social antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.7,0.8,0.9,1, 1.5, 2, 2.5, 3)) +
  coord_flip()

social_block.plot.cont

#save
ggsave(
  "social_block_using_zscores.png",
  plot = social_block.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 4
)
```

## Home environment

Have taken forward significant ones based on FDR correction.

```{r home block regression}
multinom.formula.ant.home.block <- as.formula(class_reordered ~ child_harm_recoded_05 + maternal_warmth_continuous_05 + any_domestic_violence_05 + total_social_support_05 + total_activities_with_mum_05)

multinom.reg.ant.home.block <- multinom(multinom.formula.ant.home.block, data = dat)

multinom.output.ant.home.block <- broom::tidy(multinom.reg.ant.home.block, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,7),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.home.block.full <- multinom.output.ant.home.block %>%
  mutate(Variable = rep(c("Child harm: Harmed", "Maternal warmth","Any domestic violence: Yes", "Social support", "Total activities with mum"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.home.block.full
```

```{r home block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.home.block.full.ordered <- arrange(multinom.output.ant.home.block.full, desc(RRR))

multinom.output.ant.home.block.full.ordered$Variable <- factor(multinom.output.ant.home.block.full.ordered$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.home.block.full.ordered$Variable)),
                                                    sep = ","))
```

### Z scores

```{r home block regression - zscores}
multinom.formula.ant.home.block.cont <- as.formula(class_reordered ~ child_harm_recoded_05 + z_score.maternal_warmth_continuous_05 + any_domestic_violence_05 + z_score.total_social_support_05 + z_score.total_activities_with_mum_05)

multinom.reg.ant.home.block.cont <- multinom(multinom.formula.ant.home.block.cont, data = dat)

multinom.output.ant.home.block.cont <- broom::tidy(multinom.reg.ant.home.block.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,7),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.home.block.full.cont <- multinom.output.ant.home.block.cont %>%
  mutate(Variable = rep(c("Child harm: Harmed", "Maternal warmth","Any domestic violence: Yes", "Social support", "Total activities with mum"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.home.block.full.cont
```

```{r home block graph prep - zscores}
# Arrange to be ordered by OR 
multinom.output.ant.home.block.full.ordered.cont <- arrange(multinom.output.ant.home.block.full.cont, desc(RRR)) 

# Created a leveled factor for the variables 
levels <- unique(paste(multinom.output.ant.home.block.full.ordered.cont$Variable))

multinom.output.ant.home.block.full.ordered.cont$Variable <- factor(multinom.output.ant.home.block.full.ordered.cont$Variable,
                                     levels = paste(levels,
                                                    sep = ","))
```

```{r home block plot zscores}
home_block.plot.cont <- ggplot(
  multinom.output.ant.home.block.full.ordered.cont,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Home environment antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1, 1.5, 2, 2.5, 3, 3.5, 4)) +
  coord_flip()

home_block.plot.cont

#save
ggsave(
  "home_block_using_zscores.png",
  plot = home_block.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 9,
  height = 5
)
```

## Parent characteristics environment

```{r parent block regression}
multinom.formula.ant.parent.block <- as.formula(class_reordered ~ maternal_depression_lifetime_05 + maternal_personality_openness_05 + maternal_personality_conscientiousness_05 + maternal_personality_extroversion_05 + maternal_personality_agreeableness_05 + maternal_personality_neuroticism_05 + antisocial_behaviour_parent_05)

multinom.reg.ant.parent.block <- multinom(multinom.formula.ant.parent.block, data = dat)

multinom.output.ant.parent.block <- broom::tidy(multinom.reg.ant.parent.block, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,9),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.parent.block.full <- multinom.output.ant.parent.block %>%
  mutate(Variable = rep(c("Maternal lifetime depression: Yes", "Maternal personality: Openness", "Maternal personality: Conscientiousness", "Maternal personality: Extroversion", "Maternal personality: Agreeableness", "Maternal personality: Neuroticism", "Parental antisocial behaviour"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.parent.block.full
```

```{r parent block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.parent.block.full.ordered <- arrange(multinom.output.ant.parent.block.full, desc(RRR))

# Created a leveled factor for the variables
multinom.output.ant.parent.block.full.ordered$Variable <- factor(multinom.output.ant.parent.block.full.ordered$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.parent.block.full.ordered$Variable)),
                                                    sep = ","))
```

### Zscores

```{r parent block regression - zscores}
multinom.formula.ant.parent.block.cont <- as.formula(class_reordered ~ maternal_depression_lifetime_05 + z_score.maternal_personality_openness_05 + z_score.maternal_personality_conscientiousness_05 + z_score.maternal_personality_extroversion_05 + z_score.maternal_personality_agreeableness_05 + z_score.maternal_personality_neuroticism_05 + z_score.antisocial_behaviour_parent_05) #alcoholism removed

multinom.reg.ant.parent.block.cont <- multinom(multinom.formula.ant.parent.block.cont, data = dat)

multinom.output.ant.parent.block.cont <- broom::tidy(multinom.reg.ant.parent.block.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,9),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.parent.block.full.cont <- multinom.output.ant.parent.block.cont %>%
  mutate(Variable = rep(c("Maternal lifetime depression: Yes", "Maternal personality: Openness", "Maternal personality: Conscientiousness", "Maternal personality: Extroversion", "Maternal personality: Agreeableness", "Maternal personality: Neuroticism", "Parental antisocial behaviour"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.parent.block.full.cont
```

```{r parent block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.parent.block.full.ordered.cont <- arrange(multinom.output.ant.parent.block.full.cont, desc(RRR))

# Created a leveled factor for the variables
levels <- unique(paste(multinom.output.ant.parent.block.full.ordered.cont$Variable))

multinom.output.ant.parent.block.full.ordered.cont$Variable <- factor(multinom.output.ant.parent.block.full.ordered.cont$Variable,
                                     levels = paste(levels,
                                                    sep = ","))
```

```{r parent block plot}
parent_block.plot.cont <- ggplot(
  multinom.output.ant.parent.block.full.ordered.cont,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Parent characteristic antecedents and isolation class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.25, 1.5, 1.75, 2)) +
  coord_flip()

parent_block.plot.cont

#save
ggsave(
  "parent_block_using_zscores.png",
  plot = parent_block.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 10,
  height = 5
)
```

## Child neurodevelopment 

```{r neuro block regression}
multinom.formula.ant.neuro.block <- as.formula(class_reordered ~ IQ_05 + executive_function_05 + theory_of_mind_05)

multinom.reg.ant.neuro.block <- multinom(multinom.formula.ant.neuro.block, data = dat)

multinom.output.ant.neuro.block <- broom::tidy(multinom.reg.ant.neuro.block, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,5),] %>%
   dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.neuro.block.full <- multinom.output.ant.neuro.block %>%
  mutate(Variable = rep(c("Child IQ", "Child executive function", "Child theory of mind"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.neuro.block.full
```

```{r neuro block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.neuro.block.full.ordered <- arrange(multinom.output.ant.neuro.block.full, desc(RRR))

# Created a leveled factor for the variables
multinom.output.ant.neuro.block.full.ordered$Variable <- factor(multinom.output.ant.neuro.block.full.ordered$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.neuro.block.full.ordered$Variable)),
                                                    sep = ","))
```

### Z scores 

```{r neuro block regression - zscores}
multinom.formula.ant.neuro.block.cont <- as.formula(class_reordered ~ z_score.IQ_05 + z_score.executive_function_05 + z_score.theory_of_mind_05)

multinom.reg.ant.neuro.block.cont <- multinom(multinom.formula.ant.neuro.block.cont, data = dat)

multinom.output.ant.neuro.block.cont <- broom::tidy(multinom.reg.ant.neuro.block.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,5),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.neuro.block.full.cont <- multinom.output.ant.neuro.block.cont %>%
  mutate(Variable = rep(c("Child IQ", "Child executive function", "Child theory of mind"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.neuro.block.full.cont
```

```{r neuro block graph prep z scores}
# Arrange to be ordered by OR
multinom.output.ant.neuro.block.full.ordered.cont <- arrange(multinom.output.ant.neuro.block.full.cont, desc(RRR))

# Created a leveled factor for the variables
levels <- unique(paste(multinom.output.ant.neuro.block.full.ordered.cont$Variable))

multinom.output.ant.neuro.block.full.ordered.cont$Variable <- factor(multinom.output.ant.neuro.block.full.ordered.cont$Variable,
                                     levels = paste(levels,
                                                    sep = ","))
```

```{r neuro block plot z scores}
neuro_block.plot.cont <- ggplot(
  multinom.output.ant.neuro.block.full.ordered.cont,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Child neurodevelopment antecedents and class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.2)) +
  coord_flip()

neuro_block.plot.cont

#save
ggsave(
  "neuro_block_using_zscores.png",
  plot = neuro_block.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 7,
  height = 4
)
```

## Child emotional and behavioural development 

```{r emo block regression}
multinom.formula.ant.emo.block <- as.formula(class_reordered ~ externalising_combined_05 + internalising_combined_excl_sis_05 + ADHD_combined_05 + prosocial_behaviours_combined_05)

multinom.reg.ant.emo.block <- multinom(multinom.formula.ant.emo.block, data = dat)

multinom.output.ant.emo.block <- broom::tidy(multinom.reg.ant.emo.block, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,6),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.emo.block.full <- multinom.output.ant.emo.block %>%
  mutate(Variable = rep(c("Child externalising behaviours", "Child internalising behaviours", "Child ADHD behaviours", "Child prosocial behaviours"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.emo.block.full
```

```{r emo block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.emo.block.full.ordered <- arrange(multinom.output.ant.emo.block.full, desc(RRR))

# Created a leveled factor for the variables
multinom.output.ant.emo.block.full.ordered$Variable <- factor(multinom.output.ant.emo.block.full.ordered$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.emo.block.full.ordered$Variable)),
                                                    sep = ","))
```

### Z scores 

```{r emo block regression}
multinom.formula.ant.emo.block.cont <- as.formula(class_reordered ~ z_score.externalising_combined_05 + z_score.internalising_combined_excl_sis_05 + z_score.ADHD_combined_05 + z_score.prosocial_behaviours_combined_05)

multinom.reg.ant.emo.block.cont <- multinom(multinom.formula.ant.emo.block.cont, data = dat)

multinom.output.ant.emo.block.cont <- broom::tidy(multinom.reg.ant.emo.block.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,6),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.emo.block.full.cont <- multinom.output.ant.emo.block.cont %>%
  mutate(Variable = rep(c("Child externalising behaviours", "Child internalising behaviours", "Child ADHD behaviours", "Child prosocial behaviours"),2)) %>%
    mutate(
    Significance =
      if_else(
        p.value < 0.05,
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  )

multinom.output.ant.emo.block.full.cont
```

```{r emo block graph prep}
# Arrange to be ordered by OR
multinom.output.ant.emo.block.full.ordered.cont <- arrange(multinom.output.ant.emo.block.full.cont, desc(RRR))

# Created a leveled factor for the variables
levels <- unique(paste(multinom.output.ant.emo.block.full.ordered.cont$Variable))

multinom.output.ant.emo.block.full.ordered.cont$Variable <- factor(multinom.output.ant.emo.block.full.ordered.cont$Variable,
                                     levels = paste(levels,
                                                    sep = ","))
```

```{r emo block plot}
emo_block.plot.cont <- ggplot(
  multinom.output.ant.emo.block.full.ordered.cont,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Child behavioural antecedents and class membership",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.4, 0.5, 0.6, 0.7,0.8, 0.9, 1,1.5, 2, 2.5, 3)) +
  coord_flip()

emo_block.plot.cont

#save
ggsave(
  "emo_block_using_zscores.png",
  plot = emo_block.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 7,
  height = 4
)
```

# Full antecedent model with significant variables

```{r full all sig regression}
multinom.formula.ant.all <- as.formula(class_reordered ~ SES_binary_releveled + number_children_school_free_meals_05 + child_harm_recoded_05 + total_social_support_05 + total_activities_with_mum_05 + maternal_warmth_continuous_05 + maternal_personality_conscientiousness_05 + antisocial_behaviour_parent_05 + IQ_05 + theory_of_mind_05 + executive_function_05 + internalising_combined_excl_sis_05 + ADHD_combined_05 + prosocial_behaviours_combined_05)

multinom.reg.ant.all <- multinom(multinom.formula.ant.all, data = dat)

multinom.output.ant.all <- broom::tidy(multinom.reg.ant.all, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,16),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.all.full <- multinom.output.ant.all %>%
  mutate(Variable = rep(c("SES: Low","Number of children eligible for free school meals", "Child harm: Harmed", "Social support", "Total activities with mum", "Maternal warmth", "Maternal personality: Conscientiousness", "Parental antisocial behaviour", "Child IQ", "Child theory of mind" ,"Child executive function", "Child internalising behaviours", "Child ADHD behaviours", "Child prosocial behaviours"),2)) %>%
    mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  ) 
  
multinom.output.ant.all.full
```

```{r all sig block graph prep}
# Created a leveled factor for the variables
multinom.output.ant.all.full$Variable <- factor(multinom.output.ant.all.full$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.all.full$Variable)),
                                                    sep = ","))
```

## Z scores

```{r full all sig regression}
multinom.formula.ant.all.cont <- as.formula(class_reordered ~ SES_binary_releveled + z_score.number_children_school_free_meals_05 + child_harm_recoded_05 + z_score.total_social_support_05 + z_score.total_activities_with_mum_05 + z_score.maternal_warmth_continuous_05 + z_score.maternal_personality_conscientiousness_05 + z_score.antisocial_behaviour_parent_05 + z_score.IQ_05 + z_score.theory_of_mind_05 + z_score.executive_function_05 + z_score.internalising_combined_excl_sis_05 + z_score.ADHD_combined_05 + z_score.prosocial_behaviours_combined_05)

multinom.reg.ant.all.cont <- multinom(multinom.formula.ant.all.cont, data = dat)

multinom.output.ant.all.cont <- broom::tidy(multinom.reg.ant.all.cont, conf.int = TRUE, exponentiate = TRUE, conf.level = 0.95)[-c(1,16),] %>%
    dplyr::rename(Class = y.level,
           RRR = estimate,
           RRR.conf.low = conf.low,
           RRR.conf.high = conf.high)

multinom.output.ant.all.full.cont <- multinom.output.ant.all.cont %>%
  mutate(Variable = rep(c("SES: Low","Number of children eligible for free school meals", "Child harm: Harmed", "Social support", "Total activities with mum", "Maternal warmth", "Maternal personality: Conscientiousness", "Parental antisocial behaviour", "Child IQ", "Child theory of mind" ,"Child executive function", "Child internalising behaviours", "Child ADHD behaviours", "Child prosocial behaviours"),2)) %>%
    mutate(
    Significance = 
      if_else(
        p.value < 0.05, 
        1,
        0
      ) %>%
    recode_factor(
        "0" = "Non-significant",
        "1" = "Significant"
      )
  ) 
  
multinom.output.ant.all.full.cont
```

```{r all sig block graph prep}
# Created a leveled factor for the variables
multinom.output.ant.all.full.cont$Variable <- factor(multinom.output.ant.all.full.cont$Variable,
                                     levels = paste(unique(paste(multinom.output.ant.all.full.cont$Variable)),
                                                    sep = ","))
```

```{r all sig block plot}
all.sig.plot.cont <- ggplot(
  multinom.output.ant.all.full.cont,
  aes(x = Variable,
      y = RRR,
      ymin = RRR.conf.low,
      ymax = RRR.conf.high,
      colour = Class)
  ) +
  scale_fill_manual(values = palette2b) +
  scale_color_manual(values = palette2b) +
  scale_shape_manual(values = c(21, 19)) +
  geom_pointrange(aes(shape = Significance), position = position_dodge(width = 0.7)) +
  labs(y = "RRR (95% CI)",
       x = "Symptom",
       title = "Antecedents and class membership: full model",
       subtitle = paste("N(Total) = ", length(dat$sex),
                        "; N(Increasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Increasing"])),
                        "; N(Decreasing) = ", sum(!is.na(dat$class_renamed[dat$class_renamed=="Decreasing"])), sep = ""),
       color = "",
       shape = "") +
  theme.antecedent +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = scales::log10_trans(), breaks=c(0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1, 1.5, 2, 3, 4)) +
  coord_flip()

all.sig.plot.cont

#save
ggsave(
  "All_significant_antecedents_using_zscores.png",
  plot = all.sig.plot.cont,
  device = "png",
  path = paste0(graph_save_data_path, "antecedents/analysis_interpretation"),
  width = 12,
  height = 7
)
```

